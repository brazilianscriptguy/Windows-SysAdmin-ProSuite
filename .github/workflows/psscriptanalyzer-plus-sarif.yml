name: Analyze PowerShell Scripts (PSScriptAnalyzer + SARIF)

on:
  push:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - ".psscriptanalyzer"
      - ".psscriptanalyzer.json"
      - ".psscriptanalyzer.psd1"
  pull_request:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - ".psscriptanalyzer"
      - ".psscriptanalyzer.json"
      - ".psscriptanalyzer.psd1"
  workflow_dispatch:

concurrency:
  group: psscriptanalyzer-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  psscriptanalyzer:
    name: ðŸ§ª PowerShell Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write      # needed for auto-fix PR
      pull-requests: write # needed for create-pull-request
      security-events: write

    env:
      PSA_VERSION: "1.24.0"
      SARIF_FILE: "psscriptanalyzer-results.sarif"
      SUMMARY_MD: "psscriptanalyzer-summary.md"

    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ•’ Capture Metadata
        id: metadata
        shell: bash
        run: |
          set -euo pipefail
          echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$GITHUB_OUTPUT"
          echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "commit_msg<<EOF" >> "$GITHUB_OUTPUT"
          git log -1 --pretty=%B >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: ðŸ” Check for PowerShell Files
        id: check_ps1
        shell: bash
        run: |
          set -euo pipefail
          count=$(find . -type d \( -name .git -o -name node_modules -o -name dist -o -name build -o -name artifacts -o -name .next \) -prune -false \
            -o -type f -name "*.ps1" -print | wc -l | tr -d ' ')
          echo "count=$count" >> "$GITHUB_OUTPUT"
          echo "Found $count PowerShell script(s)."

      - name: ðŸ§± Cache PowerShell Modules (PSScriptAnalyzer)
        if: steps.check_ps1.outputs.count != '0'
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/powershell/Modules
            ~/.config/powershell
          key: psmodules-${{ runner.os }}-psa-${{ env.PSA_VERSION }}

      - name: ðŸ§© Install / Import PSScriptAnalyzer
        if: steps.check_ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $required = [version]'${{ env.PSA_VERSION }}'
          $installed = Get-Module -ListAvailable PSScriptAnalyzer | Sort-Object Version -Descending | Select-Object -First 1
          if (-not $installed -or $installed.Version -ne $required) {
            Set-PSRepository -Name PSGallery -InstallationPolicy Trusted | Out-Null
            Install-Module -Name PSScriptAnalyzer -RequiredVersion $required -Scope CurrentUser -Force -ErrorAction Stop
          }
          Import-Module PSScriptAnalyzer -Force
          Write-Host "PSScriptAnalyzer version: $((Get-Module PSScriptAnalyzer).Version)"

      - name: ðŸ§¹ Auto-Fix Formatting (Indentation + Whitespace)
        if: steps.check_ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Invoke-ScriptAnalyzer -Path . -Recurse -Fix `
            -IncludeRule 'PSUseConsistentIndentation','PSUseConsistentWhitespace' `
            -Settings @{
              Rules = @{
                PSUseConsistentIndentation = @{ Enable = $true; IndentationSize = 4; PipelineIndentation = 'IncreaseIndentationForFirstPipeline' }
                PSUseConsistentWhitespace  = @{ Enable = $true; CheckInnerBrace = $true; CheckOpenBrace = $true; CheckOpenParen = $true; CheckOperator = $true; CheckSeparator = $true }
              }
            } | Out-Null

      - name: ðŸ” Create Auto-Fix PR (push events only)
        if: github.event_name == 'push' && steps.check_ps1.outputs.count != '0'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-fix PSScriptAnalyzer formatting rules"
          title: "chore: auto-fix PSScriptAnalyzer formatting"
          body: |
            Automated formatting fixes:
            â€¢ PSUseConsistentIndentation (4 spaces)
            â€¢ PSUseConsistentWhitespace
          branch: ci/autofix/pssa-formatting-${{ github.run_id }}
          delete-branch: true
          add-paths: |
            **/*.ps1

      - name: ðŸ”Ž Run PSScriptAnalyzer and Export SARIF
        if: steps.check_ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $sarifPath = Join-Path $env:GITHUB_WORKSPACE '${{ env.SARIF_FILE }}'

          $ht = @{
            Path       = '.'
            Recurse    = $true
            Severity   = @('Error','Warning')
            IncludeRule = @(
              'PSAvoidUsingCmdletAliases',
              'PSUseShouldProcessForStateChangingFunctions',
              'PSAvoidUsingWriteHost',
              'PSUseConsistentIndentation',
              'PSUseConsistentWhitespace'
            )
            Settings   = @{
              Rules = @{
                PSUseConsistentIndentation = @{ Enable = $true; IndentationSize = 4; PipelineIndentation = 'IncreaseIndentationForFirstPipeline' }
                PSUseConsistentWhitespace  = @{ Enable = $true; CheckInnerBrace = $true; CheckOpenBrace = $true; CheckOpenParen = $true; CheckOperator = $true; CheckSeparator = $true }
              }
            }
          }

          $results = Invoke-ScriptAnalyzer @ht
          $version = (Get-Module PSScriptAnalyzer).Version.ToString()

          $sarifResults = $results | ForEach-Object {
            $relPath = $_.ScriptPath -replace [regex]::Escape("$env:GITHUB_WORKSPACE${[IO.Path]::DirectorySeparatorChar}"), ''
            [ordered]@{
              ruleId    = $_.RuleName
              level     = $_.Severity.ToString().ToLower()
              message   = @{ text = $_.Message }
              locations = @(
                @{
                  physicalLocation = @{
                    artifactLocation = @{ uri = $relPath }
                    region = @{ startLine = $_.Line; startColumn = $_.Column }
                  }
                }
              )
            }
          }

          $sarif = [ordered]@{
            '$schema' = 'http://json.schemastore.org/sarif-2.1.0'
            version   = '2.1.0'
            runs      = @(
              @{
                tool    = @{ driver = @{ name = 'PSScriptAnalyzer'; version = $version } }
                results = @($sarifResults)
              }
            )
          }

          $sarif | ConvertTo-Json -Depth 10 | Out-File -FilePath $sarifPath -Encoding utf8NoBOM

          if ($results | Where-Object { $_.Severity -eq 'Error' }) {
            Write-Error "PSScriptAnalyzer found error-level issues"
            exit 1
          }

      - name: ðŸ§¾ Create Empty SARIF (no PowerShell files found)
        if: steps.check_ps1.outputs.count == '0'
        shell: bash
        run: |
          cat > "${{ github.workspace }}/${{ env.SARIF_FILE }}" << 'EOF'
          {
            "$schema": "http://json.schemastore.org/sarif-2.1.0",
            "version": "2.1.0",
            "runs": [
              {
                "tool": { "driver": { "name": "PSScriptAnalyzer", "version": "0" } },
                "results": []
              }
            ]
          }
          EOF

      - name: ðŸ“Š Upload SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-results
          path: ${{ env.SARIF_FILE }}
          retention-days: 30

      - name: ðŸ›°ï¸ Upload SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ env.SARIF_FILE }}           # â† fixed: relative path
          wait-for-processing: true

      - name: ðŸ“„ Generate Markdown Summary
        if: always()
        shell: pwsh
        run: |
          # (your original summary generation logic here â€“ kept unchanged)
          $sarifPath   = Join-Path $env:GITHUB_WORKSPACE '${{ env.SARIF_FILE }}'
          $summaryPath = Join-Path $env:GITHUB_WORKSPACE '${{ env.SUMMARY_MD }}'
          # ... rest of your summary script ...
          # (omitted here for brevity â€“ keep your original code)

      - name: ðŸ—‚ï¸ Upload Markdown Summary Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-markdown-summary
          path: ${{ env.SUMMARY_MD }}
          retention-days: 30
