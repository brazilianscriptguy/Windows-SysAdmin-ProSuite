name: Analyze PowerShell Scripts (PSScriptAnalyzer + SARIF)

on:
  push:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - ".psscriptanalyzer"
      - ".psscriptanalyzer.json"
      - ".psscriptanalyzer.psd1"
  pull_request:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - ".psscriptanalyzer"
      - ".psscriptanalyzer.json"
      - ".psscriptanalyzer.psd1"
  workflow_dispatch:

concurrency:
  group: psscriptanalyzer-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  psscriptanalyzer:
    name: ðŸ§ª PowerShell Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write
      pull-requests: write
      security-events: write

    env:
      PSA_VERSION: "1.24.0"
      SARIF_FILE: "psscriptanalyzer-results.sarif"
      SUMMARY_MD: "psscriptanalyzer-summary.md"

    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ•’ Capture Metadata
        id: metadata
        shell: bash
        run: |
          set -euo pipefail
          echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$GITHUB_OUTPUT"
          echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "commit_msg<<EOF" >> "$GITHUB_OUTPUT"
          git log -1 --pretty=%B >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: ðŸ” Check for PowerShell Files
        id: check_ps1
        shell: bash
        run: |
          set -euo pipefail
          count=$(find . \
            -type d \( -name .git -o -name node_modules -o -name dist -o -name build -o -name artifacts \) -prune -false \
            -o -type f -name "*.ps1" -print | wc -l | tr -d ' ')
          echo "count=$count" >> "$GITHUB_OUTPUT"
          echo "Found $count PowerShell script(s)."

      - name: ðŸ§± Cache PowerShell Modules
        if: steps.check_ps1.outputs.count != '0'
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/powershell/Modules
            ~/.config/powershell
          key: psmodules-${{ runner.os }}-psa-${{ env.PSA_VERSION }}

      - name: ðŸ§© Install / Import PSScriptAnalyzer
        if: steps.check_ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $required = [version]'${{ env.PSA_VERSION }}'
          $installed = Get-Module -ListAvailable -Name PSScriptAnalyzer | Sort-Object Version -Descending | Select-Object -First 1
          if (-not $installed -or $installed.Version -ne $required) {
            Set-PSRepository -Name PSGallery -InstallationPolicy Trusted | Out-Null
            Install-Module -Name PSScriptAnalyzer -RequiredVersion $required -Scope CurrentUser -Force
          }
          Import-Module PSScriptAnalyzer -Force
          Write-Host "PSScriptAnalyzer version: $((Get-Module PSScriptAnalyzer).Version)"

      - name: ðŸ§¹ Auto-Fix Formatting
        if: steps.check_ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Invoke-ScriptAnalyzer -Path . -Recurse -Fix `
            -IncludeRule 'PSUseConsistentIndentation','PSUseConsistentWhitespace' `
            -Settings @{
              Rules = @{
                PSUseConsistentIndentation = @{ Enable = $true; IndentationSize = 4; PipelineIndentation = 'IncreaseIndentationForFirstPipeline' }
                PSUseConsistentWhitespace  = @{ Enable = $true; CheckInnerBrace = $true; CheckOpenBrace = $true; CheckOpenParen = $true; CheckOperator = $true; CheckSeparator = $true }
              }
            } | Out-Null

      - name: ðŸ” Create Auto-Fix PR (push only)
        if: github.event_name == 'push' && steps.check_ps1.outputs.count != '0'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-fix PSScriptAnalyzer formatting"
          title: "chore: auto-fix PSScriptAnalyzer formatting"
          body: |
            Automated fixes:
            - PSUseConsistentIndentation
            - PSUseConsistentWhitespace
          branch: ci/autofix/psscriptanalyzer-${{ github.run_id }}
          delete-branch: true
          add-paths: |
            **/*.ps1

      - name: ðŸ”Ž Run PSScriptAnalyzer and Export SARIF
        if: steps.check_ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $sarifPath = Join-Path $env:GITHUB_WORKSPACE '${{ env.SARIF_FILE }}'
          Write-Host "Target SARIF path: $sarifPath"

          $ht = @{
            Path = '.'
            Recurse = $true
            Severity = @('Error','Warning')
            IncludeRule = @(
              'PSAvoidUsingCmdletAliases',
              'PSUseShouldProcessForStateChangingFunctions',
              'PSAvoidUsingWriteHost',
              'PSUseConsistentIndentation',
              'PSUseConsistentWhitespace'
            )
            Settings = @{
              Rules = @{
                PSUseConsistentIndentation = @{ Enable = $true; IndentationSize = 4; PipelineIndentation = 'IncreaseIndentationForFirstPipeline' }
                PSUseConsistentWhitespace = @{ Enable = $true; CheckInnerBrace = $true; CheckOpenBrace = $true; CheckOpenParen = $true; CheckOperator = $true; CheckSeparator = $true }
              }
            }
          }

          $results = Invoke-ScriptAnalyzer @ht
          Write-Host "Found $($results.Count) issues"

          $sarifResults = $results | ForEach-Object {
            $rel = $_.ScriptPath -replace [regex]::Escape("$env:GITHUB_WORKSPACE$([IO.Path]::DirectorySeparatorChar)"), ''
            $rel = $rel -replace '\\', '/'
            @{
              ruleId = $_.RuleName
              level = $_.Severity.ToString().ToLower()
              message = @{ text = $_.Message }
              locations = @(
                @{
                  physicalLocation = @{
                    artifactLocation = @{ uri = $rel }
                    region = @{ startLine = $_.Line; startColumn = $_.Column }
                  }
                }
              )
            }
          }

          $sarif = @{
            '$schema' = 'http://json.schemastore.org/sarif-2.1.0'
            version = '2.1.0'
            runs = @(
              @{
                tool = @{ driver = @{ name = 'PSScriptAnalyzer'; version = (Get-Module PSScriptAnalyzer).Version.ToString() } }
                results = $sarifResults
              }
            )
          }

          $sarif | ConvertTo-Json -Depth 12 -Compress | Set-Content -Path $sarifPath -Encoding utf8NoBOM -NoNewline -Force

          Write-Host "SARIF written â†’ exists? $(Test-Path $sarifPath)"
          if (Test-Path $sarifPath) { Get-Item $sarifPath | Select-Object Length, LastWriteTime }

          if ($results | Where-Object { $_.Severity -eq 'Error' }) {
            throw "Error-level issues found â€” failing build"
          }

      - name: ðŸ§¾ Create Empty SARIF if No Scripts Found
        if: steps.check_ps1.outputs.count == '0'
        shell: bash
        run: |
          SARIF_PATH="${{ github.workspace }}/${{ env.SARIF_FILE }}"
          echo "No .ps1 files â€” creating empty SARIF at $SARIF_PATH"
          cat > "$SARIF_PATH" <<'EOF'
          {
            "$schema": "http://json.schemastore.org/sarif-2.1.0",
            "version": "2.1.0",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "PSScriptAnalyzer",
                    "version": "0"
                  }
                },
                "results": []
              }
            ]
          }
          EOF
          ls -l "$SARIF_PATH" || echo "Failed to create empty SARIF"

      - name: ðŸ“Š Upload SARIF Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-results
          path: ${{ env.SARIF_FILE }}
          if-no-files-found: warn
          retention-days: 30

      - name: ðŸž Debug SARIF existence (temporary â€“ remove later)
        if: always()
        shell: bash
        run: |
          cd "${{ github.workspace }}"
          pwd
          echo "Looking for ${{ env.SARIF_FILE }}"
          ls -la | grep -i sarif || echo "No sarif in root"
          if [[ -f "${{ env.SARIF_FILE }}" ]]; then
            echo "SARIF exists:"
            head -n 8 "${{ env.SARIF_FILE }}"
          else
            echo "SARIF MISSING"
            find . -name "*.sarif" || echo "No SARIF anywhere"
          fi

      - name: ðŸ›°ï¸ Upload SARIF to Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ env.SARIF_FILE }}
          wait-for-processing: true

      - name: ðŸ“„ Generate Markdown Summary
        if: always()
        shell: pwsh
        run: |
          # Paste your original summary generation logic here.
          # Minimal fallback version:
          $sarifPath = Join-Path $env:GITHUB_WORKSPACE '${{ env.SARIF_FILE }}'
          $mdPath    = Join-Path $env:GITHUB_WORKSPACE '${{ env.SUMMARY_MD }}'
          $content = if (Test-Path $sarifPath) {
            $sarif = Get-Content $sarifPath -Raw | ConvertFrom-Json
            $cnt = $sarif.runs[0].results.Count
            if ($cnt -gt 0) { "**$cnt issue(s) found**" } else { "âœ… No issues" }
          } else { "âŒ SARIF not found" }

          @"
          ### PSScriptAnalyzer Summary
          - Run: ${{ github.run_id }}
          - Commit: ${{ github.sha }}
          $content
          "@ | Set-Content $mdPath -Encoding utf8

          Get-Content $mdPath | Out-File $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

      - name: ðŸ—‚ï¸ Upload Markdown Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-summary
          path: ${{ env.SUMMARY_MD }}
          retention-days: 30
