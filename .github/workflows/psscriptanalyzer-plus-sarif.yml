name: Analyze PowerShell Scripts (PSScriptAnalyzer + SARIF + AutoFix)

on:
  push:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - "**/*.psm1"
      - "**/*.psd1"
      - ".psscriptanalyzer.psd1"
      - ".psscriptanalyzer.json" # optional: keep only if you still maintain it for humans/tools
  pull_request:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - "**/*.psm1"
      - "**/*.psd1"
      - ".psscriptanalyzer.psd1"
      - ".psscriptanalyzer.json" # optional
  workflow_dispatch:

concurrency:
  group: psscriptanalyzer-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  psscriptanalyzer:
    name: üß™ PowerShell Lint + Safe AutoFix + Reports
    runs-on: ubuntu-latest
    timeout-minutes: 25

    permissions:
      contents: write
      pull-requests: write
      security-events: write

    env:
      PSA_VERSION: "1.24.0"
      SARIF_FILE: "psscriptanalyzer-results.sarif"
      JSON_FILE: "psscriptanalyzer-results.json"
      SUMMARY_MD: "psscriptanalyzer-summary.md"
      PATCH_FILE: "psscriptanalyzer-autofix.patch"

      # Keep autofix conservative and deterministic
      FIX_RULES: >-
        PSUseConsistentIndentation
        PSUseConsistentWhitespace

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Check for PowerShell Files
        id: check_ps
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          count="$(find . \
            -type d \( -name .git -o -name node_modules -o -name dist -o -name build -o -name artifacts -o -name .next \) -prune -false \
            -o -type f \( -name "*.ps1" -o -name "*.psm1" -o -name "*.psd1" \) -print | wc -l | tr -d ' ')"
          echo "count=$count" >> "$GITHUB_OUTPUT"
          echo "Found $count PowerShell file(s)."

      - name: üß± Cache PowerShell Modules (PSScriptAnalyzer)
        if: steps.check_ps.outputs.count != '0'
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/powershell/Modules
            ~/.config/powershell/Modules
          key: psmodules-${{ runner.os }}-psa-${{ env.PSA_VERSION }}

      - name: üß© Install / Import PSScriptAnalyzer
        if: steps.check_ps.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $required  = [version]'${{ env.PSA_VERSION }}'
          $installed = Get-Module -ListAvailable -Name PSScriptAnalyzer |
            Sort-Object Version -Descending | Select-Object -First 1

          if (-not $installed -or $installed.Version -ne $required) {
            Set-PSRepository -Name PSGallery -InstallationPolicy Trusted | Out-Null
            Install-Module -Name PSScriptAnalyzer -RequiredVersion $required -Scope CurrentUser -Force
          }

          Import-Module PSScriptAnalyzer -Force
          "PSScriptAnalyzer version: $((Get-Module PSScriptAnalyzer).Version)" | Write-Host

      - name: üïí Capture Metadata
        id: metadata
        if: steps.check_ps.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$GITHUB_OUTPUT"
          echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "commit_msg<<EOF" >> "$GITHUB_OUTPUT"
          git log -1 --pretty=%B >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: ‚úÖ Ensure Baseline SARIF Exists
        if: steps.check_ps.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          printf '%s' '{"$schema":"http://json.schemastore.org/sarif-2.1.0","version":"2.1.0","runs":[{"tool":{"driver":{"name":"PSScriptAnalyzer","version":"0"}},"results":[]}]}' > "${{ env.SARIF_FILE }}"

      - name: ‚úÖ Assert .psscriptanalyzer.psd1 Exists
        if: steps.check_ps.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $settings = Join-Path $env:GITHUB_WORKSPACE ".psscriptanalyzer.psd1"
          if (-not (Test-Path $settings)) { throw "Missing required PSScriptAnalyzer settings file: $settings" }
          Write-Host "Using PSScriptAnalyzer settings: $settings"

      # ----------------------------
      # SAFE AUTO-FIX (FORMAT FIRST)
      # ----------------------------
      - name: üßΩ Auto-Fix Formatting (Invoke-Formatter, PS7)
        if: steps.check_ps.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $root = $env:GITHUB_WORKSPACE

          $files = Get-ChildItem -Path $root -Recurse -File -Include *.ps1,*.psm1,*.psd1 |
            Where-Object {
              $_.FullName -notmatch '[\\/]\.git[\\/]' -and
              $_.FullName -notmatch '[\\/](node_modules|dist|build|artifacts|\.next)[\\/]'
            }

          foreach ($f in $files) {
            try {
              $formatted = Invoke-Formatter -Path $f.FullName
              $formatted | Set-Content -Path $f.FullName -Encoding utf8
            } catch {
              Write-Warning "Invoke-Formatter failed for: $($f.FullName) :: $($_.Exception.Message)"
            }
          }

      - name: üßπ Auto-Fix Analyzer Fixable Rules (-Fix)
        if: steps.check_ps.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $settingsPath = Join-Path $env:GITHUB_WORKSPACE ".psscriptanalyzer.psd1"
          if (-not (Test-Path $settingsPath)) { throw "Missing required settings file: $settingsPath" }

          $include = @("${{ env.FIX_RULES }}".Split(" ", [System.StringSplitOptions]::RemoveEmptyEntries))

          Invoke-ScriptAnalyzer -Path $env:GITHUB_WORKSPACE -Recurse -Fix `
            -IncludeRule $include `
            -Settings $settingsPath | Out-Null

      - name: üîé Detect Auto-Fix Changes
        id: detect_changes
        if: steps.check_ps.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes after auto-fix."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Detected changes after auto-fix:"
            git --no-pager diff --stat || true
          fi

      # ---------------------------------------------------------
      # PR (BEST EFFORT) OR PATCH FALLBACK
      # ---------------------------------------------------------
      - name: üîÅ Create Auto-Fix PR (best effort)
        id: cpr
        if: |
          github.event_name == 'push' &&
          steps.check_ps.outputs.count != '0' &&
          steps.detect_changes.outputs.changed == 'true' &&
          !startsWith(github.ref, 'refs/heads/ci/autofix/')
        continue-on-error: true
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-fix PowerShell formatting (PSScriptAnalyzer)"
          title: "chore: auto-fix PowerShell formatting (PSScriptAnalyzer)"
          body: |
            Automated safe fixes applied by CI:
            - Invoke-Formatter (PowerShell 7)
            - PSScriptAnalyzer -Fix (rules: PSUseConsistentIndentation, PSUseConsistentWhitespace)

            If the repo blocks CI PRs, a patch artifact is attached instead.
          branch: ci/autofix/psscriptanalyzer-${{ github.run_id }}
          delete-branch: true
          labels: |
            automated
            psscriptanalyzer
          add-paths: |
            **/*.ps1
            **/*.psm1
            **/*.psd1

      - name: üß© Create Patch Artifact (when PR cannot be created)
        if: |
          github.event_name == 'push' &&
          steps.check_ps.outputs.count != '0' &&
          steps.detect_changes.outputs.changed == 'true' &&
          (steps.cpr.outcome == 'failure')
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          echo "PR creation not permitted. Generating patch artifact."
          git diff > "${{ env.PATCH_FILE }}"
          ls -la "${{ env.PATCH_FILE }}"

      - name: üì¶ Upload Auto-Fix Patch Artifact
        if: |
          github.event_name == 'push' &&
          steps.check_ps.outputs.count != '0' &&
          steps.detect_changes.outputs.changed == 'true' &&
          (steps.cpr.outcome == 'failure')
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-autofix-patch
          path: ${{ github.workspace }}/${{ env.PATCH_FILE }}
          retention-days: 30

      # ----------------------------
      # ANALYZE + EXPORT REPORTS
      # ----------------------------
      - name: üîé Run PSScriptAnalyzer (bucketed severity) and Export JSON+SARIF
        if: steps.check_ps.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $root      = $env:GITHUB_WORKSPACE
          $sarifPath = Join-Path $root '${{ env.SARIF_FILE }}'
          $jsonPath  = Join-Path $root '${{ env.JSON_FILE }}'

          $settingsPath = Join-Path $root ".psscriptanalyzer.psd1"
          if (-not (Test-Path $settingsPath)) { throw "Missing required settings file: $settingsPath" }

          $psaVersion = (Get-Module -ListAvailable PSScriptAnalyzer | Sort-Object Version -Descending | Select-Object -First 1).Version.ToString()

          # ----------------------------
          # Severity buckets (YOU control these)
          # ----------------------------
          $errorRules = @(
            'PSAvoidUsingInvokeExpression',
            'PSUseShouldProcessForStateChangingFunctions'
          )

          $warningRules = @(
            'PSAvoidUsingWriteHost',
            'PSAvoidUsingCmdletAliases',
            'PSUseConsistentIndentation',
            'PSUseConsistentWhitespace',
            'PSAvoidUsingEmptyCatchBlock',
            'PSAvoidGlobalVars',
            'PSUseDeclaredVarsMoreThanAssignments'
          )

          # GUI-only suppressions
          $guiRegex = '(?i)(GUI|WinForms|Form|Launcher)\.(ps1|psm1)$'

          $results = @()

          # Error pass
          $err = Invoke-ScriptAnalyzer -Path $root -Recurse -Settings $settingsPath -Severity Error -IncludeRule $errorRules
          if ($err) { $results += $err }

          # Warning pass
          $warn = Invoke-ScriptAnalyzer -Path $root -Recurse -Settings $settingsPath -Severity Warning -IncludeRule $warningRules
          if ($warn) { $results += $warn }

          # GUI suppressions (post-filter)
          if ($results.Count -gt 0) {
            $results = $results | Where-Object {
              $isGui = ($_.ScriptPath -replace '\\','/' -match $guiRegex)
              if ($isGui -and $_.RuleName -in @('PSAvoidUsingWriteHost','PSAvoidUsingCmdletAliases')) { return $false }
              return $true
            }
          }

          # Export JSON
          $results | ConvertTo-Json -Depth 8 | Set-Content -Path $jsonPath -Encoding UTF8

          # Build SARIF
          $sarifResults = @()
          if ($results) {
            $sarifResults = $results | ForEach-Object {
              $rel = $_.ScriptPath.Replace("$root/", '').Replace("$root\", '')
              @{
                ruleId    = $_.RuleName
                level     = $_.Severity.ToString().ToLower()
                message   = @{ text = $_.Message }
                locations = @(
                  @{
                    physicalLocation = @{
                      artifactLocation = @{ uri = $rel }
                      region           = @{ startLine = $_.Line; startColumn = $_.Column }
                    }
                  }
                )
              }
            }
          }

          $sarif = @{
            '$schema' = 'http://json.schemastore.org/sarif-2.1.0'
            version   = '2.1.0'
            runs      = @(
              @{
                tool    = @{ driver = @{ name = 'PSScriptAnalyzer'; version = $psaVersion } }
                results = $sarifResults
              }
            )
          }

          $sarif | ConvertTo-Json -Depth 12 | Set-Content -Path $sarifPath -Encoding UTF8

          if (-not (Test-Path $sarifPath)) { throw "SARIF was not created at: $sarifPath" }
          if (-not (Test-Path $jsonPath))  { throw "JSON was not created at: $jsonPath"  }

          # Fail ONLY if error bucket produced any findings
          if ($err -and $err.Count -gt 0) {
            throw "PSScriptAnalyzer found error-level findings (bucketed)."
          }

      - name: üìä Upload SARIF + JSON Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-results
          path: |
            ${{ github.workspace }}/${{ env.SARIF_FILE }}
            ${{ github.workspace }}/${{ env.JSON_FILE }}
          retention-days: 30

      - name: üõ∞Ô∏è Upload SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ github.workspace }}/${{ env.SARIF_FILE }}
          wait-for-processing: true

      - name: üìÑ Generate Markdown Summary (top issues + counts)
        if: always()
        shell: pwsh
        run: |
          $summaryPath = Join-Path $env:GITHUB_WORKSPACE '${{ env.SUMMARY_MD }}'
          $jsonPath    = Join-Path $env:GITHUB_WORKSPACE '${{ env.JSON_FILE }}'

          $repo  = "${{ github.repository }}"
          $sha   = "${{ github.sha }}"
          $runId = "${{ github.run_id }}"

          $lines = New-Object System.Collections.Generic.List[string]
          $lines.Add("### üß™ PowerShell Lint Summary")
          $lines.Add("- üïí **Timestamp (UTC):** ${{ steps.metadata.outputs.timestamp }}")
          $lines.Add("- üîó **Repo:** $repo")
          $lines.Add("- üß∑ **Commit:** $sha")
          $lines.Add("- üßæ **Run:** $runId")
          $lines.Add("")

          if (Test-Path $jsonPath) {
            $items = @()
            $raw = Get-Content $jsonPath -Raw
            if ($raw.Trim().Length -gt 0) { $items = @( $raw | ConvertFrom-Json ) }

            if ($items.Count -gt 0) {
              $lines.Add("**Detected $($items.Count) issue(s)**")
              $lines.Add("")

              $lines.Add("**Counts by rule (top 15):**")
              $topRules = $items | Group-Object RuleName | Sort-Object Count -Descending | Select-Object -First 15
              foreach ($r in $topRules) { $lines.Add("- `$($r.Name)`: $($r.Count)") }
              $lines.Add("")

              $lines.Add("**First 20 findings:**")
              foreach ($i in ($items | Select-Object -First 20)) {
                $file = ($i.ScriptPath -replace [regex]::Escape($env:GITHUB_WORKSPACE + [IO.Path]::DirectorySeparatorChar), '').Replace('\','/')
                $line = [int]$i.Line
                $link = "https://github.com/$repo/blob/$sha/$file#L$line"
                $lines.Add("- [$($i.Severity)] `$($i.RuleName)`: $($i.Message) ([file]($link))")
              }
            } else {
              $lines.Add("‚úÖ No issues found.")
            }
          } else {
            $lines.Add("‚ùó JSON results not found.")
          }

          $out = ($lines -join "`n")
          $out | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          $out | Out-File -FilePath $summaryPath -Encoding utf8

      - name: üóÇÔ∏è Upload Markdown Summary Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-markdown-summary
          path: ${{ github.workspace }}/${{ env.SUMMARY_MD }}
          retention-days: 30

  ps51-parse-check:
    name: üß© PowerShell 5.1 Parse Compatibility Check (Windows)
    runs-on: windows-latest
    timeout-minutes: 15
    needs: psscriptanalyzer

    permissions:
      contents: read

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚úÖ Parse all scripts with Windows PowerShell 5.1
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $files = Get-ChildItem -Recurse -File -Include *.ps1,*.psm1,*.psd1 |
            Where-Object {
              $_.FullName -notmatch '\\\.git\\' -and
              $_.FullName -notmatch '\\(node_modules|dist|build|artifacts|\.next)\\'
            }

          if (-not $files -or $files.Count -eq 0) {
            Write-Host "No PowerShell files found. Skipping."
            exit 0
          }

          $fail = 0
          foreach ($f in $files) {
            $tokens = $null
            $errors = $null
            [System.Management.Automation.Language.Parser]::ParseFile($f.FullName, [ref]$tokens, [ref]$errors) | Out-Null
            if ($errors -and $errors.Count -gt 0) {
              $fail++
              Write-Host "==== PARSE ERROR: $($f.FullName) ===="
              $errors | ForEach-Object { Write-Host $_.Message }
            }
          }

          if ($fail -gt 0) { throw "PowerShell 5.1 parse failed for $fail file(s)." }

          Write-Host "PowerShell 5.1 parse check: OK"
