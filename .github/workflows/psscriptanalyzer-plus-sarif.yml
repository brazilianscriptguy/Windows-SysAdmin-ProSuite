name: Analyze PowerShell Scripts (PSScriptAnalyzer + SARIF)

on:
  push:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - ".psscriptanalyzer"
      - ".psscriptanalyzer.json"
      - ".psscriptanalyzer.psd1"
  pull_request:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - ".psscriptanalyzer"
      - ".psscriptanalyzer.json"
      - ".psscriptanalyzer.psd1"
  workflow_dispatch:

concurrency:
  group: psscriptanalyzer-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  psscriptanalyzer:
    name: ðŸ§ª PowerShell Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write
      pull-requests: write
      security-events: write

    env:
      PSA_VERSION: "1.24.0"
      SARIF_FILE: "psscriptanalyzer-results.sarif"
      SUMMARY_MD: "psscriptanalyzer-summary.md"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for .ps1 files
        id: check_ps1
        shell: bash
        run: |
          count=$(find . -type d \( -name .git -o -name node_modules \) -prune -o -name "*.ps1" -print | wc -l | tr -d ' ')
          echo "count=$count" >> "$GITHUB_OUTPUT"

      - name: Cache PSScriptAnalyzer
        if: steps.check_ps1.outputs.count != '0'
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/powershell/Modules
            ~/.config/powershell
          key: psmodules-ubuntu-psa-${{ env.PSA_VERSION }}

      - name: Install PSScriptAnalyzer
        if: steps.check_ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $reqVer = [version]'${{ env.PSA_VERSION }}'
          if (-not (Get-Module -ListAvailable PSScriptAnalyzer | ? { $_.Version -eq $reqVer })) {
            Install-Module PSScriptAnalyzer -RequiredVersion $reqVer -Scope CurrentUser -Force
          }
          Import-Module PSScriptAnalyzer -RequiredVersion $reqVer -Force

      - name: Run PSScriptAnalyzer + Generate SARIF
        id: generate_sarif
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $sarifPath = Join-Path $env:GITHUB_WORKSPACE '${{ env.SARIF_FILE }}'
          Write-Output "SARIF target: $sarifPath"

          try {
            $analyzerParams = @{
              Path       = '.'
              Recurse    = $true
              Severity   = 'Error','Warning'
              IncludeRule = 'PSAvoidUsingCmdletAliases','PSAvoidUsingWriteHost','PSUseShouldProcessForStateChangingFunctions','PSUseConsistentIndentation','PSUseConsistentWhitespace'
              Settings   = @{ Rules = @{ PSUseConsistentIndentation = @{ Enable = $true; IndentationSize = 4 }; PSUseConsistentWhitespace = @{ Enable = $true } } }
            }
            $issues = Invoke-ScriptAnalyzer @analyzerParams -ErrorAction Stop
            Write-Output "Issues found: $($issues.Count)"

            $sarifIssues = $issues | % {
              $relPath = $_.ScriptPath -replace [regex]::Escape($env:GITHUB_WORKSPACE + [IO.Path]::DirectorySeparatorChar), '' -replace '\\','/'
              @{ ruleId = $_.RuleName; level = $_.Severity.ToString().ToLower(); message = @{text = $_.Message}; locations = @(@{physicalLocation=@{artifactLocation=@{uri=$relPath}; region=@{startLine=$_.Line; startColumn=$_.Column}}}) }
            }

            $sarifObj = @{
              '$schema' = 'http://json.schemastore.org/sarif-2.1.0'
              version   = '2.1.0'
              runs      = @(@{ tool = @{driver = @{name='PSScriptAnalyzer'; version=(Get-Module PSScriptAnalyzer).Version}}; results = $sarifIssues })
            }

            $sarifObj | ConvertTo-Json -Depth 10 -Compress | Set-Content -Path $sarifPath -Encoding utf8NoBOM -Force
            Write-Output "SARIF written. Exists? $(Test-Path $sarifPath)"
          }
          catch {
            Write-Output "Generation failed: $_"
            # Fallback: empty SARIF so upload doesn't die
            @{ '$schema'='http://json.schemastore.org/sarif-2.1.0'; version='2.1.0'; runs=@(@{tool=@{driver=@{name='PSScriptAnalyzer'}}; results=@()}) } |
              ConvertTo-Json -Depth 5 | Set-Content -Path $sarifPath -Encoding utf8NoBOM -Force
          }
          finally {
            if (Test-Path $sarifPath) { Write-Output "Final SARIF size: $((Get-Item $sarifPath).Length) bytes" }
          }

      - name: Create empty SARIF fallback (if no scripts or generation skipped)
        if: always() && !steps.generate_sarif.conclusion == 'success' || steps.check_ps1.outputs.count == '0'
        shell: bash
        run: |
          touch "${{ github.workspace }}/${{ env.SARIF_FILE }}" 2>/dev/null || true
          cat > "${{ github.workspace }}/${{ env.SARIF_FILE }}" <<'EOF'
          {"$schema":"http://json.schemastore.org/sarif-2.1.0","version":"2.1.0","runs":[{"tool":{"driver":{"name":"PSScriptAnalyzer"}},"results":[]}]}
          EOF

      - name: Debug SARIF file status
        if: always()
        shell: bash
        run: |
          cd "${{ github.workspace }}"
          ls -la *sarif* 2>/dev/null || echo "No sarif file visible"
          if [ -f "${{ env.SARIF_FILE }}" ]; then
            echo "File exists:"
            wc -c "${{ env.SARIF_FILE }}"
            head -n 5 "${{ env.SARIF_FILE }}"
          else
            echo "File DOES NOT exist at ${{ env.SARIF_FILE }}"
            find . -name "*sarif*" 2>/dev/null || echo "No sarif files anywhere"
          fi

      - name: Upload SARIF to Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ env.SARIF_FILE }}
          wait-for-processing: true

      # ... keep your artifact upload, auto-fix PR, summary steps as before ...
      # (add similar debug logging if needed)
