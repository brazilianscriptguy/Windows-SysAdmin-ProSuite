name: Analyze PowerShell Scripts (PSScriptAnalyzer + SARIF)

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.ps1'
      - '.psscriptanalyzer'
      - '.psscriptanalyzer.json'
      - '.psscriptanalyzer.psd1'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.ps1'
      - '.psscriptanalyzer'
      - '.psscriptanalyzer.json'
      - '.psscriptanalyzer.psd1'
  workflow_dispatch:

concurrency:
  group: psscriptanalyzer-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  psscriptanalyzer:
    name: ðŸ§ª PowerShell Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write          # for auto-fix PR
      pull-requests: write     # for create-pull-request
      security-events: write   # for code scanning upload

    env:
      PSA_VERSION: "1.24.0"
      SARIF_FILE: "psscriptanalyzer-results.sarif"
      SUMMARY_MD: "psscriptanalyzer-summary.md"

    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ•’ Capture commit metadata
        id: metadata
        shell: bash
        run: |
          echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$GITHUB_OUTPUT"
          echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "commit_msg<<EOF" >> "$GITHUB_OUTPUT"
          git log -1 --pretty=%B >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: ðŸ” Count PowerShell files
        id: check_ps1
        shell: bash
        run: |
          count=$(find . -type d \( -name .git -o -name node_modules \) -prune -o -type f -name "*.ps1" -print | wc -l | tr -d ' ')
          echo "count=$count" >> "$GITHUB_OUTPUT"
          echo "â†’ Found $count .ps1 file(s)"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Only run the heavy steps if we actually have PowerShell files
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ðŸ§± Cache PSScriptAnalyzer
        if: steps.check_ps1.outputs.count != '0'
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/powershell/Modules
            ~/.config/powershell
          key: psmodules-${{ runner.os }}-psa-${{ env.PSA_VERSION }}

      - name: ðŸ§© Install & Import PSScriptAnalyzer
        if: steps.check_ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $ver = '${{ env.PSA_VERSION }}'
          if (-not (Get-Module -ListAvailable PSScriptAnalyzer | Where-Object { $_.Version -eq $ver })) {
            Set-PSRepository -Name PSGallery -InstallationPolicy Trusted -ErrorAction SilentlyContinue
            Install-Module PSScriptAnalyzer -RequiredVersion $ver -Scope CurrentUser -Force
          }
          Import-Module PSScriptAnalyzer -RequiredVersion $ver -Force
          Write-Host "PSScriptAnalyzer version: $((Get-Module PSScriptAnalyzer).Version)"

      - name: ðŸ§¹ Auto-fix formatting (Indent + Whitespace)
        if: steps.check_ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Invoke-ScriptAnalyzer -Path . -Recurse -Fix `
            -IncludeRule 'PSUseConsistentIndentation','PSUseConsistentWhitespace' `
            -Settings @{
              Rules = @{
                PSUseConsistentIndentation = @{ Enable = $true; IndentationSize = 4 }
                PSUseConsistentWhitespace  = @{ Enable = $true; CheckInnerBrace = $true; CheckOpenBrace = $true; CheckOpenParen = $true; CheckOperator = $true; CheckSeparator = $true }
              }
            } | Out-Null

      - name: ðŸ” Create auto-fix Pull Request (only on push)
        if: github.event_name == 'push' && steps.check_ps1.outputs.count != '0'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-fix PowerShell formatting (PSScriptAnalyzer)"
          title: "chore: auto-fix PowerShell formatting"
          body: |
            Automated formatting fixes applied by CI:
            â€¢ PSUseConsistentIndentation (4 spaces)
            â€¢ PSUseConsistentWhitespace
          branch: ci/autofix/pssa-formatting-${{ github.run_id }}
          delete-branch: true
          add-paths: |
            **/*.ps1

      - name: ðŸ”Ž Run PSScriptAnalyzer â†’ generate SARIF
        if: steps.check_ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $sarifPath = Join-Path $env:GITHUB_WORKSPACE '${{ env.SARIF_FILE }}'

          $params = @{
            Path       = '.'
            Recurse    = $true
            Severity   = @('Error','Warning')
            IncludeRule = @(
              'PSAvoidUsingCmdletAliases',
              'PSAvoidUsingWriteHost',
              'PSUseShouldProcessForStateChangingFunctions',
              'PSUseConsistentIndentation',
              'PSUseConsistentWhitespace'
            )
            Settings   = @{
              Rules = @{
                PSUseConsistentIndentation = @{ Enable = $true; IndentationSize = 4 }
                PSUseConsistentWhitespace  = @{ Enable = $true; CheckInnerBrace = $true; CheckOpenBrace = $true; CheckOpenParen = $true; CheckOperator = $true; CheckSeparator = $true }
              }
            }
          }

          $issues = Invoke-ScriptAnalyzer @params

          $sarifIssues = $issues | ForEach-Object {
            $relPath = $_.ScriptPath -replace [regex]::Escape($env:GITHUB_WORKSPACE + [IO.Path]::DirectorySeparatorChar), ''
            [ordered]@{
              ruleId    = $_.RuleName
              level     = $_.Severity.ToString().ToLower()
              message   = @{ text = $_.Message }
              locations = @(
                @{
                  physicalLocation = @{
                    artifactLocation = @{ uri = $relPath }
                    region           = @{ startLine = $_.Line; startColumn = $_.Column }
                  }
                }
              )
            }
          }

          $sarif = [ordered]@{
            '$schema' = 'http://json.schemastore.org/sarif-2.1.0'
            version   = '2.1.0'
            runs      = @(
              @{
                tool = @{ driver = @{ name = 'PSScriptAnalyzer'; version = (Get-Module PSScriptAnalyzer).Version.ToString() } }
                results = @($sarifIssues)
              }
            )
          }

          $sarif | ConvertTo-Json -Depth 10 -Compress | Set-Content -Path $sarifPath -Encoding UTF8 -NoNewline

          if ($issues | Where-Object { $_.Severity -eq 'Error' }) {
            Write-Error "PSScriptAnalyzer found ERROR level issues"
          }

      - name: ðŸ§¾ Create empty SARIF (no .ps1 files found)
        if: steps.check_ps1.outputs.count == '0'
        shell: bash
        run: |
          cat > "${{ github.workspace }}/${{ env.SARIF_FILE }}" << 'EOF'
          {
            "$schema": "http://json.schemastore.org/sarif-2.1.0",
            "version": "2.1.0",
            "runs": [
              {
                "tool": { "driver": { "name": "PSScriptAnalyzer", "version": "0" } },
                "results": []
              }
            ]
          }
          EOF

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Uploads â”€ always run (even on failure / no files)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ðŸ“Š Upload SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-results
          path: ${{ env.SARIF_FILE }}
          if-no-files-found: warn
          retention-days: 14

      - name: ðŸ›°ï¸ Upload SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ env.SARIF_FILE }}           # â† this is the correct relative path
          wait-for-processing: true

      - name: ðŸ“„ Generate Markdown summary
        if: always()
        shell: pwsh
        run: |
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # You can keep / paste your original summary generation logic here
          # For brevity I'm leaving a minimal version â€” feel free to replace
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          $sarifPath = Join-Path $env:GITHUB_WORKSPACE '${{ env.SARIF_FILE }}'
          $mdPath    = Join-Path $env:GITHUB_WORKSPACE '${{ env.SUMMARY_MD }}'

          $lines = @(
            "### PSScriptAnalyzer Summary",
            "Run: ${{ github.run_id }}",
            "Commit: ${{ github.sha }}",
            ""
          )

          if (Test-Path $sarifPath) {
            $sarif = Get-Content $sarifPath -Raw | ConvertFrom-Json
            $count = $sarif.runs[0].results.Count
            if ($count -gt 0) {
              $lines += "**Found $count issue(s)**"
            } else {
              $lines += "**No issues found** âœ“"
            }
          } else {
            $lines += "**SARIF file not found**"
          }

          $lines -join "`n" | Set-Content $mdPath -Encoding UTF8

          # Write to job summary
          $lines -join "`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

      - name: ðŸ—‚ï¸ Upload Markdown summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-summary
          path: ${{ env.SUMMARY_MD }}
          if-no-files-found: warn
          retention-days: 7
          
