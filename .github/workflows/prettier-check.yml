name: Prettier Code Format Check

on:
  push:
    branches: [main, develop]
    paths:
      - "**/*.js"
      - "**/*.ts"
      - "**/*.jsx"
      - "**/*.tsx"
      - "**/*.css"
      - "**/*.json"
      - "**/*.md"
      - ".prettierrc"
      - ".prettierignore"
      - "package.json"
      - "package-lock.json"
      - "pnpm-lock.yaml"
      - "yarn.lock"
  pull_request:
    branches: [main, develop]
    paths:
      - "**/*.js"
      - "**/*.ts"
      - "**/*.jsx"
      - "**/*.tsx"
      - "**/*.css"
      - "**/*.json"
      - "**/*.md"
      - ".prettierrc"
      - ".prettierignore"
      - "package.json"
      - "package-lock.json"
      - "pnpm-lock.yaml"
      - "yarn.lock"
  workflow_dispatch:

concurrency:
  group: prettier-check-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  prettier:
    name: üíÖ Prettier Code Format Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      # Enterprise default:
      # "true"  => report-only (never fail)
      # "false" => enforce formatting (fail on violations)
      ALLOW_WARNINGS: "true"

      PRETTIER_REPORT: "prettier-report.txt"
      PRETTIER_SUMMARY: "prettier-summary.md"
      NPM_DEBUG_LOG: "npm-debug.log"

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üßæ Detect Package Manager
        id: pm
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f pnpm-lock.yaml ]]; then
            echo "manager=pnpm" >> "$GITHUB_OUTPUT"
          elif [[ -f yarn.lock ]]; then
            echo "manager=yarn" >> "$GITHUB_OUTPUT"
          elif [[ -f package-lock.json ]]; then
            echo "manager=npm" >> "$GITHUB_OUTPUT"
          else
            echo "manager=npm" >> "$GITHUB_OUTPUT"
          fi

      - name: üì• Install Dependencies (deterministic when possible)
        shell: bash
        run: |
          set -euo pipefail
          mgr="${{ steps.pm.outputs.manager }}"

          if [[ "$mgr" == "pnpm" ]]; then
            corepack enable
            pnpm -v
            pnpm install --frozen-lockfile
          elif [[ "$mgr" == "yarn" ]]; then
            corepack enable
            yarn -v
            yarn install --frozen-lockfile
          else
            if [[ -f package-lock.json ]]; then
              npm ci
            else
              echo "::warning::No lockfile found. Falling back to 'npm install' (non-deterministic)."
              npm install
            fi
          fi

      - name: üîç Run Prettier (robust execution)
        id: prettier
        shell: bash
        run: |
          set -euo pipefail

          # Why this exists:
          # You hit: "npm error could not determine executable to run"
          # That usually happens when:
          # - prettier is not installed (devDependencies missing), OR
          # - lockfile/install didn't run, OR
          # - npx can't find a local binary.
          #
          # Enterprise approach: require a local prettier dependency,
          # and run it via node_modules/.bin to avoid npx ambiguity.

          report="${PRETTIER_REPORT}"

          if [[ ! -x "node_modules/.bin/prettier" ]]; then
            echo "::error::Prettier not found in node_modules. Add it to devDependencies: npm i -D prettier"
            echo "exit_code=2" >> "$GITHUB_OUTPUT"
            echo "prettier_present=false" >> "$GITHUB_OUTPUT"
            printf '%s\n' "Prettier not installed. Add it to devDependencies." > "$report"
            exit 0
          fi

          set +e
          node_modules/.bin/prettier --check . > "$report" 2>&1
          ec="$?"
          set -e

          echo "exit_code=$ec" >> "$GITHUB_OUTPUT"
          echo "prettier_present=true" >> "$GITHUB_OUTPUT"
          echo "Prettier exit code: $ec"

      - name: üßæ Capture npm debug log (if any)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          # NPM stores logs in ~/.npm/_logs/*.log; capture latest if exists
          if compgen -G "/home/runner/.npm/_logs/*-debug-0.log" > /dev/null; then
            latest="$(ls -t /home/runner/.npm/_logs/*-debug-0.log | head -n 1)"
            cp "$latest" "${NPM_DEBUG_LOG}" || true
          else
            echo "No npm debug log found." > "${NPM_DEBUG_LOG}"
          fi

      - name: üìÑ Generate GitHub Job Summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          exit_code="${{ steps.prettier.outputs.exit_code }}"
          prettier_present="${{ steps.prettier.outputs.prettier_present }}"

          {
            echo "### üíÖ Prettier Format Summary"
            echo
            echo "- **Ref:** \`${GITHUB_REF}\`"
            echo "- **Commit:** \`${GITHUB_SHA}\`"
            echo "- **Exit code:** \`${exit_code}\`"
            echo "- **ALLOW_WARNINGS:** \`${ALLOW_WARNINGS}\`"
            echo "- **Prettier installed:** \`${prettier_present}\`"
            echo

            if [[ "${prettier_present}" != "true" ]]; then
              echo "‚ùó Prettier was not found in \`node_modules\`."
              echo
              echo "**Fix:** add Prettier to devDependencies:"
              echo
              echo '```bash'
              echo 'npm i -D prettier'
              echo '```'
              echo
            elif [[ "$exit_code" != "0" ]]; then
              echo "‚ö†Ô∏è Formatting issues detected."
              echo
              echo "**Top 80 lines:**"
              echo
              echo '```text'
              head -n 80 "${PRETTIER_REPORT}" || true
              echo '```'
              echo
              echo "_Output truncated. Download artifacts for full report._"
            else
              echo "‚úÖ No formatting issues found."
            fi
          } | tee "${PRETTIER_SUMMARY}" >> "$GITHUB_STEP_SUMMARY"

      - name: üìä Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prettier-format-report
          path: |
            ${{ env.PRETTIER_REPORT }}
            ${{ env.PRETTIER_SUMMARY }}
            ${{ env.NPM_DEBUG_LOG }}
          retention-days: 30

      - name: ‚úÖ Policy Gate (optional enforcement)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${ALLOW_WARNINGS}" == "true" ]]; then
            echo "ALLOW_WARNINGS=true -> report-only mode. Passing."
            exit 0
          fi

          prettier_present="${{ steps.prettier.outputs.prettier_present }}"
          exit_code="${{ steps.prettier.outputs.exit_code }}"

          if [[ "${prettier_present}" != "true" ]]; then
            echo "‚ùå Prettier is missing from node_modules. Enforced mode requires it."
            exit 1
          fi

          if [[ "$exit_code" != "0" ]]; then
            echo "‚ùå Failing due to Prettier formatting violations."
            exit 1
          fi

          echo "‚úÖ Prettier passed."
