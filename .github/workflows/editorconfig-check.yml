name: EditorConfig Check

on:
  push:
    branches: [main, develop]
    paths:
      - ".editorconfig"
      - "**/.editorconfig"
      - "**/*"
  pull_request:
    branches: [main, develop]
    paths:
      - ".editorconfig"
      - "**/.editorconfig"
      - "**/*"
  workflow_dispatch:

concurrency:
  group: editorconfig-check-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  editorconfig-check:
    name: üîç EditorConfig Lint
    runs-on: ubuntu-latest

    env:
      # "true" => never fail the job (report only)
      # "false" => fail only on REAL violations (not on exit=2)
      ALLOW_WARNINGS: "false"
      EC_VERSION: "3.0.3"

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      - name: üì• Install EditorConfig Checker
        shell: bash
        run: |
          set -euo pipefail

          url="https://github.com/editorconfig-checker/editorconfig-checker/releases/download/v${EC_VERSION}/ec-linux-amd64.tar.gz"
          echo "Downloading: $url"

          tmpdir="$(mktemp -d)"
          curl -fsSL "$url" -o "$tmpdir/ec.tar.gz"

          mkdir -p "$tmpdir/ec"
          tar -xzf "$tmpdir/ec.tar.gz" -C "$tmpdir/ec"

          BIN="$(find "$tmpdir/ec" -maxdepth 6 -type f \( -name 'ec-linux-amd64' -o -name 'ec' \) | head -n 1 || true)"
          if [[ -z "${BIN:-}" ]]; then
            echo "‚ùå Error: ec binary not found after extraction"
            find "$tmpdir/ec" -maxdepth 6 -print
            exit 1
          fi

          sudo install -m 0755 "$BIN" /usr/local/bin/ec
          /usr/local/bin/ec --version

      - name: ‚ñ∂Ô∏è Run EditorConfig Checker (capture output + exit code)
        id: ec
        shell: bash
        run: |
          set -euo pipefail

          set +e
          /usr/local/bin/ec --disable-logs . 2>&1 | tee ec-output.txt
          ec_exit="${PIPESTATUS[0]}"
          set -e

          echo "exit_code=$ec_exit" >> "$GITHUB_OUTPUT"
          echo "EditorConfig Checker exit code: $ec_exit"

      - name: üìã Generate Markdown Summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          {
            echo "### üîç EditorConfig Check Summary"
            echo
            echo "- **Ref:** \`${GITHUB_REF}\`"
            echo "- **Commit:** \`${GITHUB_SHA}\`"
            echo "- **Allow warnings:** \`${ALLOW_WARNINGS}\`"
            echo "- **EC version:** \`${EC_VERSION}\`"
            echo "- **Exit code:** \`${{ steps.ec.outputs.exit_code }}\`"
            echo

            if [[ -f ec-output.txt ]] && grep -q "^\[" ec-output.txt; then
              echo "**Violations found (top 30 lines):**"
              echo
              echo '```text'
              head -n 30 ec-output.txt
              echo '```'
              echo
              echo "_Output truncated. See artifact: ec-output.txt_"
            else
              echo "‚úÖ No violations detected (or no violation lines matched)."
              echo
              echo "_If exit code is non-zero, check ec-output.txt for details._"
            fi
          } | tee ec-summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: üìÇ Upload Lint Results as Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: editorconfig-lint-results
          path: |
            ec-output.txt
            ec-summary.md
          retention-days: 30

      - name: üö´ Enforce (fail only on actual violations)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          exit_code="${{ steps.ec.outputs.exit_code }}"

          # IMPORTANT:
          # In your environment, ec is returning exit=2 even when you do NOT want to fail the job.
          # We'll enforce based on "violation lines" instead of exit code:
          # - Fail only if output contains lines starting with "[" (your original detection logic).
          # - Otherwise pass, even if exit code is 2.
          if [[ "${ALLOW_WARNINGS}" == "true" ]]; then
            echo "ALLOW_WARNINGS=true -> reporting only. Passing."
            exit 0
          fi

          if [[ -f ec-output.txt ]] && grep -q "^\[" ec-output.txt; then
            echo "‚ùå EditorConfig violations detected (matched output lines). Failing."
            exit 1
          fi

          echo "‚úÖ No violations detected by output pattern. Passing."
