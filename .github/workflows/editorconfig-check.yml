name: EditorConfig Check [Report-Only]

on:
  push:
    branches: [main, develop]
    paths:
      - ".editorconfig"
      - "**/.editorconfig"
      - "**/*.ps1"
      - "**/*.psm1"
      - "**/*.psd1"
      - "**/*.md"
      - "**/*.yml"
      - "**/*.yaml"
      - "**/*.json"
      - "**/*.xml"
  pull_request:
    branches: [main, develop]
    paths:
      - ".editorconfig"
      - "**/.editorconfig"
      - "**/*.ps1"
      - "**/*.psm1"
      - "**/*.psd1"
      - "**/*.md"
      - "**/*.yml"
      - "**/*.yaml"
      - "**/*.json"
      - "**/*.xml"
  workflow_dispatch:

concurrency:
  group: editorconfig-check-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  editorconfig-check:
    name: ðŸ” EditorConfig Lint (Report-Only)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      # REPORT-ONLY: never fail the workflow (even if violations exist)
      REPORT_ONLY: "true"

      # Pin for deterministic installs
      EC_VERSION: "3.0.3"

      # Output
      OUT_DIR: "editorconfig-reports"
      EC_OUTPUT: "ec-output.txt"
      EC_SUMMARY: "ec-summary.md"

    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“ Ensure output folder exists
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${OUT_DIR}"

      - name: ðŸ“¥ Install EditorConfig Checker (pinned)
        shell: bash
        run: |
          set -euo pipefail

          URL="https://github.com/editorconfig-checker/editorconfig-checker/releases/download/v${EC_VERSION}/ec-linux-amd64.tar.gz"
          TMPDIR="$(mktemp -d)"
          curl -fsSL "${URL}" -o "${TMPDIR}/ec.tar.gz"

          mkdir -p "${TMPDIR}/ec"
          tar -xzf "${TMPDIR}/ec.tar.gz" -C "${TMPDIR}/ec"

          BIN="$(find "${TMPDIR}/ec" -maxdepth 6 -type f \( -name 'ec-linux-amd64' -o -name 'ec' \) | head -n 1 || true)"
          if [[ -z "${BIN:-}" ]]; then
            echo "âŒ Error: 'ec' binary not found after extraction."
            find "${TMPDIR}/ec" -maxdepth 6 -print
            exit 1
          fi

          sudo install -m 0755 "${BIN}" /usr/local/bin/ec
          /usr/local/bin/ec --version

      - name: â–¶ï¸ Run EditorConfig Checker (capture output + exit code)
        id: ec
        shell: bash
        run: |
          set -euo pipefail

          OUT_TXT="${OUT_DIR}/${EC_OUTPUT}"

          set +e
          /usr/local/bin/ec . 2>&1 | tee "${OUT_TXT}"
          EC_EXIT="${PIPESTATUS[0]}"
          set -e

          echo "exit_code=${EC_EXIT}" >> "${GITHUB_OUTPUT}"
          echo "EditorConfig Checker exit code: ${EC_EXIT}"

      - name: ðŸ§¾ Classify result (clean / violations / tool failure)
        id: policy
        shell: bash
        run: |
          set -euo pipefail

          EC_EXIT="${{ steps.ec.outputs.exit_code }}"
          if [[ "${EC_EXIT}" == "0" ]]; then
            echo "status=clean" >> "${GITHUB_OUTPUT}"
          elif [[ "${EC_EXIT}" == "1" ]]; then
            echo "status=violations" >> "${GITHUB_OUTPUT}"
          else
            echo "status=tool_failure" >> "${GITHUB_OUTPUT}"
          fi

      - name: ðŸ“‹ Publish Run Summary (View Runs)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          OUT_TXT="${OUT_DIR}/${EC_OUTPUT}"
          OUT_MD="${OUT_DIR}/${EC_SUMMARY}"

          STATUS="${{ steps.policy.outputs.status }}"
          EXIT_CODE="${{ steps.ec.outputs.exit_code }}"

          {
            echo "## ðŸ” EditorConfig Check (Report-Only)"
            echo
            echo "- **Workflow:** \`${{ github.workflow }}\`"
            echo "- **Event:** \`${{ github.event_name }}\`"
            echo "- **Ref:** \`${{ github.ref }}\`"
            echo "- **Commit:** \`${{ github.sha }}\`"
            echo "- **EC version:** \`${EC_VERSION}\`"
            echo "- **Exit code:** \`${EXIT_CODE}\`"
            echo "- **Status:** \`${STATUS}\`"
            echo "- **REPORT_ONLY:** \`${REPORT_ONLY}\`"
            echo

            if [[ "${STATUS}" == "tool_failure" ]]; then
              echo "âŒ **Tool failure** â€” EditorConfig Checker did not run successfully."
              echo
              echo "**Output (top 120 lines):**"
              echo
              echo '```text'
              head -n 120 "${OUT_TXT}" || true
              echo '```'
              echo
              echo "_Fix the workflow/tool invocation; results are not trustworthy._"

            elif [[ "${STATUS}" == "violations" ]]; then
              echo "âš ï¸ **Violations detected** (report-only â€” workflow does not fail)"
              echo
              echo "**Output (top 120 lines):**"
              echo
              echo '```text'
              head -n 120 "${OUT_TXT}" || true
              echo '```'
              echo
              echo "_Output truncated. Download artifacts for full details._"

            else
              echo "âœ… **No violations detected.**"
            fi

            echo
            echo "### ðŸ“¦ Artifacts"
            echo "- \`${OUT_DIR}/${EC_OUTPUT}\`"
            echo "- \`${OUT_DIR}/${EC_SUMMARY}\`"
          } | tee "${OUT_MD}" >> "${GITHUB_STEP_SUMMARY}"

      - name: ðŸ“¦ Upload Artifacts (output + summary)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: editorconfig-check
          path: ${{ env.OUT_DIR }}/**
          if-no-files-found: warn
          retention-days: 30

      - name: âœ… Finalize (report-only mode never fails)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "Report-only workflow: always passing regardless of violations."
          exit 0
