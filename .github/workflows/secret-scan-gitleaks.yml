name: Secret Scan (Gitleaks) [Report-Only]

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: secret-scan-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  gitleaks:
    name: Gitleaks Scan (SARIF + Artifacts) [Report-Only]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      GITLEAKS_VERSION: "8.30.0"
      OUT_DIR: secret-scan-reports
      OUT_SARIF: gitleaks.sarif
      OUT_JSON: gitleaks.json
      OUT_LOG: gitleaks.log
      CONFIG_FILE: .gitleaks.toml

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure output folder exists
        run: mkdir -p "${{ env.OUT_DIR }}"

      - name: Initialize empty SARIF baseline
        if: always()
        run: |
          cat > "${{ env.OUT_DIR }}/${{ env.OUT_SARIF }}" << 'EOF'
          {
            "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
            "version": "2.1.0",
            "runs": [
              { "tool": { "driver": { "name": "gitleaks", "version": "0" } }, "results": [] }
            ]
          }
          EOF

      - name: Install Gitleaks (pinned)
        if: always()
        run: |
          set -euo pipefail
          VER="${{ env.GITLEAKS_VERSION }}"
          curl -sSL -o /tmp/gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${VER}/gitleaks_${VER}_linux_x64.tar.gz"
          tar -xzf /tmp/gitleaks.tar.gz -C /tmp gitleaks
          sudo mv /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Run Gitleaks (SARIF + JSON + Log) [Report-Only]
        if: always()
        run: |
          set +e

          CFG=""
          if [ -f "${{ env.CONFIG_FILE }}" ]; then
            CFG="--config=${{ env.CONFIG_FILE }}"
          fi

          # SARIF
          gitleaks detect --source="." --redact $CFG \
            --report-format=sarif \
            --report-path="${{ env.OUT_DIR }}/${{ env.OUT_SARIF }}" \
            2>&1 | tee "${{ env.OUT_DIR }}/${{ env.OUT_LOG }}"

          # JSON (second report output; keep report-only)
          gitleaks detect --source="." --redact $CFG \
            --report-format=json \
            --report-path="${{ env.OUT_DIR }}/${{ env.OUT_JSON }}" \
            >/dev/null 2>&1

          exit 0

      - name: Upload artifacts (reports)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-reports
          path: ${{ env.OUT_DIR }}/**
          if-no-files-found: warn
          retention-days: 30

      - name: Upload SARIF to GitHub Code Scanning
        if: always() && hashFiles(format('{0}/{1}', env.OUT_DIR, env.OUT_SARIF)) != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ env.OUT_DIR }}/${{ env.OUT_SARIF }}
          category: secrets/gitleaks
