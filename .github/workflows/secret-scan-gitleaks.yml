name: Secret Scan (Gitleaks) [Report-Only]

on:
  push:
    branches: [main, develop]
    paths:
      - "**/*"
      - ".github/workflows/secret-scan-gitleaks.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "**/*"
      - ".github/workflows/secret-scan-gitleaks.yml"
  workflow_dispatch:

concurrency:
  group: secret-scan-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  gitleaks:
    name: Gitleaks Scan (SARIF + Artifacts) [Report-Only]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      OUT_DIR: "secret-scan-reports"
      OUT_SARIF: "gitleaks.sarif"
      OUT_JSON: "gitleaks.json"
      OUT_LOG: "gitleaks.log"

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure output folder exists
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${OUT_DIR}"

      - name: Initialize SARIF baseline (always create file)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          cat > "${OUT_DIR}/${OUT_SARIF}" << 'EOF'
          {
            "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
            "version": "2.1.0",
            "runs": [
              {
                "tool": { "driver": { "name": "gitleaks", "version": "0" } },
                "results": []
              }
            ]
          }
          EOF

      - name: Run Gitleaks (report-only)
        if: always()
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ARGS: >-
            detect
            --source=.
            --redact
            --report-format=sarif
            --report-path=${{ env.OUT_DIR }}/${{ env.OUT_SARIF }}
            --report-path=${{ env.OUT_DIR }}/${{ env.OUT_SARIF }}

      # NOTE:
      # gitleaks-action focuses on SARIF; to also produce JSON/log reliably,
      # we run a second invocation via the gitleaks binary (pinned) below.

      - name: Install Gitleaks (pinned)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          # Pinned version for repeatability
          VER="8.21.2"
          curl -sSL -o /tmp/gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${VER}/gitleaks_${VER}_linux_x64.tar.gz"
          tar -xzf /tmp/gitleaks.tar.gz -C /tmp gitleaks
          sudo mv /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Run Gitleaks JSON + Log (report-only)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          set +e

          gitleaks detect \
            --source="." \
            --redact \
            --report-format="json" \
            --report-path="${OUT_DIR}/${OUT_JSON}" \
            2>&1 | tee "${OUT_DIR}/${OUT_LOG}"

          # Never fail CI (report-only)
          exit 0

      - name: Pre-upload diagnostics
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "Workspace: ${GITHUB_WORKSPACE}"
          echo "OUT_DIR: ${OUT_DIR}"
          ls -la "${OUT_DIR}" || true

      - name: Upload secret scan artifacts (never fail if empty)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-reports
          path: ${{ env.OUT_DIR }}/**
          if-no-files-found: warn
          retention-days: 30

      - name: Upload SARIF to GitHub Code Scanning (report-only)
        if: always() && hashFiles(format('{0}/{1}', env.OUT_DIR, env.OUT_SARIF)) != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ env.OUT_DIR }}/${{ env.OUT_SARIF }}
          category: secrets/gitleaks
