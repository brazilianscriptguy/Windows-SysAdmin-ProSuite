# .github/workflows/secret-scan-gitleaks.yml
name: Secret Scan (Gitleaks) [Report-Only]

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: secret-scan-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  gitleaks:
    name: Gitleaks Scan (PR-fast / Main-full) [Report-Only]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      GITLEAKS_VERSION: "8.30.0"
      OUT_DIR: "secret-scan-reports"
      OUT_SARIF: "gitleaks.sarif"
      OUT_JSON: "gitleaks.json"
      OUT_LOG: "gitleaks.log"
      CONFIG_FILE: ".gitleaks.toml"

    steps:
      - name: Checkout (PR-fast / Main-full)
        uses: actions/checkout@v4
        with:
          # PR: shallow is fine (fast). Main push: full history for maximum coverage.
          fetch-depth: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 0 || 2 }}

      - name: Ensure output folder exists
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${OUT_DIR}"

      - name: Install Gitleaks (pinned)
        shell: bash
        run: |
          set -euo pipefail
          VER="${GITLEAKS_VERSION}"
          curl -sSL -o /tmp/gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${VER}/gitleaks_${VER}_linux_x64.tar.gz"
          tar -xzf /tmp/gitleaks.tar.gz -C /tmp gitleaks
          sudo mv /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Run Gitleaks (PR-fast / Main-full) [Report-Only]
        if: always()
        shell: bash
        run: |
          # Report-only: never fail the job
          set +e

          CFG=()
          if [ -f "${CONFIG_FILE}" ]; then
            CFG=(--config="${CONFIG_FILE}")
          fi

          # PR: scan working tree only (no history) to keep it fast.
          # Main push: full history (because fetch-depth=0).
          EXTRA=()
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            EXTRA=(--no-git)
          fi

          gitleaks detect \
            --source="." \
            --redact \
            "${CFG[@]}" \
            "${EXTRA[@]}" \
            --report-format="json" \
            --report-path="${OUT_DIR}/${OUT_JSON}" \
            2>&1 | tee "${OUT_DIR}/${OUT_LOG}"

          # Convert JSON -> SARIF (no re-scan)
          python3 - << 'PY'
          import json, os, sys
          out_dir = os.environ["OUT_DIR"]
          json_path = os.path.join(out_dir, os.environ["OUT_JSON"])
          sarif_path = os.path.join(out_dir, os.environ["OUT_SARIF"])
          ver = os.environ.get("GITLEAKS_VERSION","0")

          sarif = {
            "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
            "version": "2.1.0",
            "runs": [{
              "tool": {"driver": {"name": "gitleaks", "version": ver}},
              "results": []
            }]
          }

          try:
            with open(json_path, "r", encoding="utf-8") as f:
              data = json.load(f)
          except Exception:
            with open(sarif_path, "w", encoding="utf-8") as f:
              json.dump(sarif, f, ensure_ascii=False, indent=2)
            sys.exit(0)

          if isinstance(data, list):
            for item in data:
              file_path = item.get("File") or item.get("file") or item.get("Path") or ""
              start_line = item.get("StartLine") or item.get("startLine") or item.get("Line") or item.get("line") or 1
              rule_id = item.get("RuleID") or item.get("ruleID") or item.get("Rule") or "gitleaks"
              desc = item.get("Description") or item.get("description") or "Potential secret detected"
              msg = f"{desc} (rule: {rule_id})"

              try:
                start_line = int(start_line)
              except Exception:
                start_line = 1

              sarif["runs"][0]["results"].append({
                "ruleId": str(rule_id),
                "level": "error",
                "message": {"text": msg},
                "locations": [{
                  "physicalLocation": {
                    "artifactLocation": {"uri": file_path},
                    "region": {"startLine": start_line}
                  }
                }]
              })

          with open(sarif_path, "w", encoding="utf-8") as f:
            json.dump(sarif, f, ensure_ascii=False, indent=2)
          PY

          exit 0

      - name: Upload artifacts (reports)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-reports
          path: ${{ env.OUT_DIR }}/**
          if-no-files-found: warn
          retention-days: 30

      - name: Upload SARIF to GitHub Code Scanning
        if: always() && hashFiles(format('{0}/{1}', env.OUT_DIR, env.OUT_SARIF)) != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ env.OUT_DIR }}/${{ env.OUT_SARIF }}
          category: secrets/gitleaks
