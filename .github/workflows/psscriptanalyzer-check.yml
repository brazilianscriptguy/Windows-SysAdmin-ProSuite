name: Analyze PowerShell Scripts (PSScriptAnalyzer + SARIF)

on:
  push:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - ".psscriptanalyzer"
  pull_request:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - ".psscriptanalyzer"
  workflow_dispatch:

concurrency:
  group: psscriptanalyzer-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  psscriptanalyzer:
    name: ðŸ§ª PowerShell Code Quality Check
    runs-on: ubuntu-latest

    permissions:
      contents: write          # needed only if auto-fix PR is enabled
      security-events: write   # required for SARIF upload
      pull-requests: write     # needed only if auto-fix PR is enabled

    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check for PowerShell Files
        id: check-ps1
        shell: bash
        run: |
          count=$(find . -type f -name "*.ps1" | wc -l | tr -d ' ')
          echo "count=$count" >> "$GITHUB_OUTPUT"
          echo "Found $count PowerShell script(s)."

      - name: ðŸ› ï¸ Install PSScriptAnalyzer
        if: steps.check-ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Get-Module -ListAvailable -Name PSScriptAnalyzer)) {
            Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -RequiredVersion 1.24.0
          }
          Import-Module PSScriptAnalyzer -Force
          (Get-Module PSScriptAnalyzer).Version.ToString() | Write-Output

      - name: ðŸ§¹ Auto-Fix (Indentation + Whitespace)
        if: steps.check-ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $htFix = @{
            Path = '.'
            Recurse = $true
            Fix = $true
            IncludeRule = @('PSUseConsistentIndentation', 'PSUseConsistentWhitespace')
            Settings = @{
              Rules = @{
                PSUseConsistentIndentation = @{
                  Enable = $true
                  IndentationSize = 4
                  PipelineIndentation = 'IncreaseIndentationForFirstPipeline'
                }
                PSUseConsistentWhitespace = @{
                  Enable = $true
                  CheckInnerBrace = $true
                  CheckOpenBrace = $true
                  CheckOpenParen = $true
                  CheckOperator = $true
                  CheckSeparator = $true
                }
              }
            }
          }

          Invoke-ScriptAnalyzer @htFix | Out-Null

      # Best-practice: DO NOT push to main/develop from CI.
      # Instead, open a PR with autofix changes (only on push events).
      - name: ðŸ” Create Auto-Fix PR
        if: github.event_name == 'push' && steps.check-ps1.outputs.count != '0'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-fix PSScriptAnalyzer formatting"
          title: "chore: auto-fix PSScriptAnalyzer formatting"
          body: |
            This PR applies automated formatting fixes:
            - PSUseConsistentIndentation
            - PSUseConsistentWhitespace
          branch: "ci/autofix/psscriptanalyzer-${{ github.run_id }}"
          delete-branch: true

      - name: ðŸ”Ž Run PSScriptAnalyzer and Export SARIF
        if: steps.check-ps1.outputs.count != '0'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $sarifFile = Join-Path $env:GITHUB_WORKSPACE 'psscriptanalyzer-results.sarif'
          $version = (Get-Module -ListAvailable PSScriptAnalyzer | Select-Object -First 1).Version.ToString()

          $htPSA = @{
            Path = '.'
            Recurse = $true
            Severity = @('Error', 'Warning')
            IncludeRule = @(
              'PSAvoidUsingCmdletAliases',
              'PSUseShouldProcessForStateChangingFunctions',
              'PSAvoidUsingWriteHost',
              'PSUseConsistentIndentation',
              'PSUseConsistentWhitespace'
            )
            Settings = @{
              Rules = @{
                PSUseConsistentIndentation = @{
                  Enable = $true
                  IndentationSize = 4
                  PipelineIndentation = 'IncreaseIndentationForFirstPipeline'
                }
                PSUseConsistentWhitespace = @{
                  Enable = $true
                  CheckInnerBrace = $true
                  CheckOpenBrace = $true
                  CheckOpenParen = $true
                  CheckOperator = $true
                  CheckSeparator = $true
                }
              }
            }
          }

          $results = Invoke-ScriptAnalyzer @htPSA

          # Always write a SARIF file (even if empty) so upload steps never fail.
          $sarifResults = @()
          if ($results) {
            $sarifResults = $results | ForEach-Object {
              $rel = $_.ScriptPath.Replace("$env:GITHUB_WORKSPACE/", '').Replace("$env:GITHUB_WORKSPACE\", '')
              @{
                ruleId = $_.RuleName
                level  = $_.Severity.ToString().ToLower()
                message = @{ text = $_.Message }
                locations = @(
                  @{
                    physicalLocation = @{
                      artifactLocation = @{ uri = $rel }
                      region = @{ startLine = $_.Line; startColumn = $_.Column }
                    }
                  }
                )
              }
            }
          }

          $sarif = @{
            '$schema' = 'http://json.schemastore.org/sarif-2.1.0'
            version = '2.1.0'
            runs = @(
              @{
                tool = @{ driver = @{ name = 'PSScriptAnalyzer'; version = $version } }
                results = $sarifResults
              }
            )
          }

          $sarif | ConvertTo-Json -Depth 12 | Out-File -FilePath $sarifFile -Encoding utf8

          if ($results | Where-Object { $_.Severity -eq 'Error' }) {
            Write-Error "PSScriptAnalyzer found error-level findings."
            exit 1
          }

      - name: ðŸ§¾ Create Empty SARIF (No .ps1 Files)
        if: steps.check-ps1.outputs.count == '0'
        shell: bash
        run: |
          cat > psscriptanalyzer-results.sarif <<'EOF'
          {"$schema":"http://json.schemastore.org/sarif-2.1.0","version":"2.1.0","runs":[{"tool":{"driver":{"name":"PSScriptAnalyzer","version":"0"}},"results":[]}]}
          EOF

      - name: ðŸ“Š Upload SARIF Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-results
          path: ${{ github.workspace }}/psscriptanalyzer-results.sarif
          retention-days: 30

      - name: ðŸ›°ï¸ Upload SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ github.workspace }}/psscriptanalyzer-results.sarif
          wait-for-processing: true

      - name: ðŸ“„ Generate Markdown Summary
        if: always()
        shell: pwsh
        run: |
          $summaryPath = Join-Path $env:GITHUB_WORKSPACE "psscriptanalyzer-summary.md"
          $sarifPath   = Join-Path $env:GITHUB_WORKSPACE "psscriptanalyzer-results.sarif"

          $repo  = "${{ github.repository }}"
          $sha   = "${{ github.sha }}"
          $runId = "${{ github.run_id }}"

          $lines = @()
          $lines += "### ðŸ§ª PowerShell Lint Summary"
          $lines += "- ðŸ”— **Repo:** $repo"
          $lines += "- ðŸ§· **Commit:** $sha"
          $lines += "- ðŸ§¾ **Run:** $runId"
          $lines += ""

          if (Test-Path $sarifPath) {
            $sarif = Get-Content $sarifPath -Raw | ConvertFrom-Json
            $issues = @()
            if ($sarif.runs.Count -gt 0 -and $sarif.runs[0].results) {
              $issues = @($sarif.runs[0].results)
            }

            if ($issues.Count -gt 0) {
              $lines += "**Detected $($issues.Count) issue(s):**"
              foreach ($i in $issues | Select-Object -First 15) {
                $file = $i.locations[0].physicalLocation.artifactLocation.uri
                $line = $i.locations[0].physicalLocation.region.startLine
                $link = "https://github.com/$repo/blob/$sha/$file#L$line"
                $lines += "- [$($i.level)] `$($i.ruleId)`: $($i.message.text) ([file]($link))"
              }
            } else {
              $lines += "âœ… No issues found."
            }
          } else {
            $lines += "â— SARIF results not found."
          }

          $out = ($lines -join "`n")
          $out | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          $out | Out-File -FilePath $summaryPath -Encoding utf8

      - name: ðŸ—‚ï¸ Upload Markdown Summary Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-markdown-summary
          path: ${{ github.workspace }}/psscriptanalyzer-summary.md
          retention-days: 30
