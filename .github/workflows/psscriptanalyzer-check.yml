name: Analyze PowerShell Scripts

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '**/*.ps1'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**/*.ps1'
  workflow_dispatch:

jobs:
  psscriptanalyzer:
    name: PowerShell Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: ðŸ§ª Run PSScriptAnalyzer
        uses: microsoft/psscriptanalyzer-action@v1.1
        with:
          path: '.'
          recurse: true
          severity: "Error,Warning"  # âœ… Fixed YAML syntax
          enableExit: true
          settings: |
            @{
              IncludeRules = @(
                'PSAvoidUsingCmdletAliases',
                'PSUseShouldProcessForStateChangingFunctions',
                'PSAvoidUsingWriteHost',
                'PSUseConsistentIndentation',
                'PSUseConsistentWhitespace'
              )
              Rules = @{
                PSUseConsistentIndentation = @{
                  Enable = $true
                  IndentationSize = 4
                  PipelineIndentation = 'IncreaseIndentationForFirstPipeline'
                }
                PSUseConsistentWhitespace = @{
                  Enable = $true
                  CheckInnerBrace = $true
                  CheckOpenBrace = $true
                  CheckOpenParen = $true
                  CheckOperator = $true
                  CheckSeparator = $true
                }
              }
            }

      - name: ðŸ“Š Upload PSScriptAnalyzer Results (Optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-results
          path: psscriptanalyzer-results.sarif
          retention-days: 7
