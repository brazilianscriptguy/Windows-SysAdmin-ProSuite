name: PowerShell Code Quality Check

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '**/*.ps1'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**/*.ps1'
  workflow_dispatch:

jobs:
  psscriptanalyzer:
    name: Analyze PowerShell Code
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: üõ†Ô∏è Setup PowerShell
        uses: actions/setup-pwsh@v1
        with:
          pwsh-version: '7.4'

      - name: üîç Run PSScriptAnalyzer with SARIF Output
        shell: pwsh
        run: |
          # Create hashtable for ScriptAnalyzer settings
          $htPSA = [ordered]@{
              Path = '.'
              Recurse = $true
              EnableExit = $true
              Severity = @('Error', 'Warning')
              IncludeRules = @(
                'PSAvoidUsingCmdletAliases',
                'PSUseShouldProcessForStateChangingFunctions',
                'PSAvoidUsingWriteHost',
                'PSUseConsistentIndentation',
                'PSUseConsistentWhitespace'
              )
              Rules = @{
                PSUseConsistentIndentation = @{
                  Enable = $true
                  IndentationSize = 4
                  PipelineIndentation = 'IncreaseIndentationForFirstPipeline'
                }
                PSUseConsistentWhitespace = @{
                  Enable = $true
                  CheckInnerBrace = $true
                  CheckOpenBrace = $true
                  CheckOpenParen = $true
                  CheckOperator = $true
                  CheckSeparator = $true
                }
              }
          }

          # Prepare SARIF output
          $htCTS = [ordered]@{ FilePath = 'results.sarif' }

          # Run analysis
          Invoke-ScriptAnalyzer @htPSA | ConvertTo-SARIF @htCTS

      - name: üìä Upload SARIF Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-results
          path: results.sarif
          retention-days: 7
