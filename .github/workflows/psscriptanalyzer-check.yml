name: Analyze PowerShell Scripts

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '**/*.ps1'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**/*.ps1'
  workflow_dispatch:

jobs:
  psscriptanalyzer:
    name: PowerShell Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: üõ†Ô∏è Setup PowerShell
        uses: actions/setup-powershell@v1
        with:
          powershell-version: '7.4'

      - name: üîé Run PSScriptAnalyzer and Export SARIF
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $htPSA = @{
            Path = '.'
            Recurse = $true
            Severity = @('Error', 'Warning')
            IncludeRule = @(
              'PSAvoidUsingCmdletAliases',
              'PSUseShouldProcessForStateChangingFunctions',
              'PSAvoidUsingWriteHost',
              'PSUseConsistentIndentation',
              'PSUseConsistentWhitespace'
            )
            Settings = @{
              Rules = @{
                PSUseConsistentIndentation = @{
                  Enable = $true
                  IndentationSize = 4
                  PipelineIndentation = 'IncreaseIndentationForFirstPipeline'
                }
                PSUseConsistentWhitespace = @{
                  Enable = $true
                  CheckInnerBrace = $true
                  CheckOpenBrace = $true
                  CheckOpenParen = $true
                  CheckOperator = $true
                  CheckSeparator = $true
                }
              }
            }
          }

          $htCTS = @{
            FilePath = 'psscriptanalyzer-results.sarif'
          }

          Invoke-ScriptAnalyzer @htPSA | ConvertTo-SARIF @htCTS

      - name: üìä Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-results
          path: psscriptanalyzer-results.sarif
          retention-days: 7
