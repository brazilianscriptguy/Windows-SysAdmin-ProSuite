name: Analyze PowerShell Scripts

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '**/*.ps1'
      - '.psscriptanalyzer'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**/*.ps1'
      - '.psscriptanalyzer'
  workflow_dispatch:

jobs:
  psscriptanalyzer:
    name: PowerShell Code Quality Check
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      security-events: write
      statuses: write

    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: ðŸ”Ž Run PSScriptAnalyzer and Export SARIF
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $htPSA = @{
            Path = '.'
            Recurse = $true
            Severity = @('Error', 'Warning')
            IncludeRule = @(
              'PSAvoidUsingCmdletAliases',
              'PSUseShouldProcessForStateChangingFunctions',
              'PSAvoidUsingWriteHost',
              'PSUseConsistentIndentation',
              'PSUseConsistentWhitespace'
            )
            Settings = @{
              Rules = @{
                PSUseConsistentIndentation = @{
                  Enable = $true
                  IndentationSize = 4
                  PipelineIndentation = 'IncreaseIndentationForFirstPipeline'
                }
                PSUseConsistentWhitespace = @{
                  Enable = $true
                  CheckInnerBrace = $true
                  CheckOpenBrace = $true
                  CheckOpenParen = $true
                  CheckOperator = $true
                  CheckSeparator = $true
                }
              }
            }
          }

          $htCTS = @{
            FilePath = 'psscriptanalyzer-results.sarif'
          }

          try {
            Invoke-ScriptAnalyzer @htPSA | ConvertTo-SARIF @htCTS
          } catch {
            Write-Error "PSScriptAnalyzer failed: $_"
            exit 1
          }

      - name: ðŸ“Š Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: psscriptanalyzer-results
          path: psscriptanalyzer-results.sarif
          retention-days: 7

      - name: ðŸ“¤ Upload SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: psscriptanalyzer-results.sarif
          
