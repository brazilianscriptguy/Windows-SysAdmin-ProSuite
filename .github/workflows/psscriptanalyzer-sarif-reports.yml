name: PowerShell Corporate Lint (PSScriptAnalyzer + SARIF + Reports)

on:
  push:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - "**/*.psm1"
      - "**/*.psd1"
      - ".psscriptanalyzer.psd1"
      - ".github/workflows/psscriptanalyzer-sarif-reports.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "**/*.ps1"
      - "**/*.psm1"
      - "**/*.psd1"
      - ".psscriptanalyzer.psd1"
      - ".github/workflows/psscriptanalyzer-sarif-reports.yml"
  workflow_dispatch: {}

concurrency:
  group: powershell-lint-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  psa-analyze:
    name: üß™ Analyze (PSScriptAnalyzer 1.24.0) + Reports
    runs-on: windows-latest
    timeout-minutes: 30

    permissions:
      contents: read
      security-events: write

    env:
      PSA_VERSION: "1.24.0"
      SETTINGS_FILE: ".psscriptanalyzer.psd1"

      OUT_DIR: "lint-reports"
      OUT_JSON: "psa-results.json"
      OUT_CSV: "psa-results.csv"
      OUT_MD: "psa-results.md"
      OUT_SARIF: "psa-results.sarif"

      # Repo roots to scan (recursive)
      ANALYZE_ROOTS: >-
        BlueTeam-Tools
        Core-ScriptLibrary
        ITSM-Templates-SVR
        ITSM-Templates-WKS
        ProSuite-Hub
        SysAdmin-Tools

      # Hard-exclude path with long path issues (and you don't want to analyze it)
      EXCLUDE_PATH_REGEX: '(?i)SysAdmin-Tools[\\/]+GroupPolicyObjects-Templates[\\/]'

      # Prune folders from scanning
      PRUNE_DIR_REGEX: '(?i)[\\/](\.git|node_modules|dist|build|artifacts|\.next)[\\/]'

      # Gate policy: job FAILS if any findings exist with these severities
      FAIL_ON_SEVERITIES: "Error"

      SUMMARY_TOP: "25"
      TOP_RULES: "20"

    steps:
      - name: üì¶ Checkout (sparse; exclude GPO Templates long paths)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout-cone-mode: false
          sparse-checkout: |
            .github/
            .psscriptanalyzer.psd1
            BlueTeam-Tools/
            Core-ScriptLibrary/
            ITSM-Templates-SVR/
            ITSM-Templates-WKS/
            ProSuite-Hub/
            SysAdmin-Tools/
            !SysAdmin-Tools/GroupPolicyObjects-Templates/

      - name: üïí Capture run metadata
        id: meta
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          "timestamp=$(Get-Date -AsUTC -Format 'yyyy-MM-ddTHH:mm:ssZ')" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "sha=$env:GITHUB_SHA" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "repo=$env:GITHUB_REPOSITORY" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "run_id=$env:GITHUB_RUN_ID" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: ‚úÖ Ensure report folder + baseline files exist (always)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $root   = $env:GITHUB_WORKSPACE
          $outDir = Join-Path $root "${{ env.OUT_DIR }}"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          # Baseline SARIF (GitHub rejects runAutomationDetails; do NOT include it)
          $sarifPath = Join-Path $outDir "${{ env.OUT_SARIF }}"
          $baseline = @{
            '$schema' = 'http://json.schemastore.org/sarif-2.1.0'
            version   = '2.1.0'
            runs      = @(
              @{
                tool    = @{ driver = @{ name = 'PSScriptAnalyzer'; version = '0' } }
                results = @()
              }
            )
          }
          $baseline | ConvertTo-Json -Depth 12 | Set-Content -Path $sarifPath -Encoding UTF8

          # Baseline JSON/CSV/MD
          '[]' | Set-Content -Path (Join-Path $outDir "${{ env.OUT_JSON }}") -Encoding UTF8
          "Severity,RuleName,Message,File,Line,Column,EndLine,EndColumn,ScriptName" |
            Set-Content -Path (Join-Path $outDir "${{ env.OUT_CSV }}") -Encoding UTF8
          "# PowerShell Static Analysis Report`n`n(Baseline created.)" |
            Set-Content -Path (Join-Path $outDir "${{ env.OUT_MD }}") -Encoding UTF8

      - name: üß© Install / Import PSScriptAnalyzer
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $required = [version]'${{ env.PSA_VERSION }}'

          $installed = Get-Module -ListAvailable -Name PSScriptAnalyzer |
            Sort-Object Version -Descending | Select-Object -First 1

          if (-not $installed -or $installed.Version -ne $required) {
            Set-PSRepository -Name PSGallery -InstallationPolicy Trusted | Out-Null
            Install-Module -Name PSScriptAnalyzer -RequiredVersion $required -Scope CurrentUser -Force
          }

          Import-Module PSScriptAnalyzer -Force
          Write-Host "PSScriptAnalyzer version: $((Get-Module PSScriptAnalyzer).Version)"

      - name: ‚úÖ Validate .psscriptanalyzer.psd1
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $settingsPath = Join-Path $env:GITHUB_WORKSPACE "${{ env.SETTINGS_FILE }}"
          if (-not (Test-Path $settingsPath)) { throw "Missing settings file: $settingsPath" }

          $cfg = Import-PowerShellDataFile -Path $settingsPath
          if (-not ($cfg -is [hashtable])) { throw "Settings file is not a hashtable: $settingsPath" }

          $validKeys = @('CustomRulePath','ExcludeRules','IncludeRules','IncludeDefaultRules','RecurseCustomRulePath','Rules','Severity')
          foreach ($k in $cfg.Keys) {
            if ($k -notin $validKeys) {
              throw "Invalid key in .psscriptanalyzer.psd1: '$k'. Valid keys: $($validKeys -join ', ')"
            }
          }

          Write-Host "Settings file OK: $settingsPath"

      - name: üîé Run PSScriptAnalyzer + Build Reports (JSON/CSV/MD/SARIF)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $root      = $env:GITHUB_WORKSPACE
          $settings  = Join-Path $root "${{ env.SETTINGS_FILE }}"
          $outDir    = Join-Path $root "${{ env.OUT_DIR }}"
          $jsonPath  = Join-Path $outDir "${{ env.OUT_JSON }}"
          $csvPath   = Join-Path $outDir "${{ env.OUT_CSV }}"
          $mdPath    = Join-Path $outDir "${{ env.OUT_MD }}"
          $sarifPath = Join-Path $outDir "${{ env.OUT_SARIF }}"

          $pruneRx   = [regex]::new("${{ env.PRUNE_DIR_REGEX }}")
          $excludeRx = [regex]::new("${{ env.EXCLUDE_PATH_REGEX }}")

          $repo  = "${{ steps.meta.outputs.repo }}"
          $sha   = "${{ steps.meta.outputs.sha }}"
          $ts    = "${{ steps.meta.outputs.timestamp }}"
          $runId = "${{ steps.meta.outputs.run_id }}"

          $psaVersion = (Get-Module -ListAvailable PSScriptAnalyzer | Sort-Object Version -Descending | Select-Object -First 1).Version.ToString()

          # Resolve roots
          $roots = @("${{ env.ANALYZE_ROOTS }}".Split(" ", [System.StringSplitOptions]::RemoveEmptyEntries)) |
            ForEach-Object { Join-Path $root $_ } |
            Where-Object { (Test-Path $_) -and (-not $pruneRx.IsMatch($_)) }

          if (-not $roots -or $roots.Count -eq 0) {
            throw "No valid ANALYZE_ROOTS found. Check env.ANALYZE_ROOTS."
          }

          $all = New-Object System.Collections.Generic.List[object]

          foreach ($r in $roots) {
            $rRel = $r.Replace("$root$([IO.Path]::DirectorySeparatorChar)", '')
            Write-Host "Analyzing root: $rRel"

            $res = Invoke-ScriptAnalyzer -Path $r -Recurse -Settings $settings -Severity @('Error','Warning','Information')
            if ($res) {
              foreach ($x in $res) {
                if ($x -and $x.ScriptPath -and (-not $excludeRx.IsMatch($x.ScriptPath))) {
                  $all.Add($x)
                }
              }
            }
          }

          # Normalize rows
          $rows = New-Object System.Collections.Generic.List[object]
          foreach ($x in $all) {
            $rel = $x.ScriptPath.Replace("$root$([IO.Path]::DirectorySeparatorChar)", '').Replace('\','/')
            $rows.Add([pscustomobject]@{
              Severity   = [string]$x.Severity
              RuleName   = [string]$x.RuleName
              Message    = [string]$x.Message
              File       = $rel
              Line       = [int]$x.Line
              Column     = [int]$x.Column
              EndLine    = [int]$x.EndLine
              EndColumn  = [int]$x.EndColumn
              ScriptName = [string]$x.ScriptName
            })
          }

          # Write JSON/CSV
          $rows | ConvertTo-Json -Depth 8 | Set-Content -Path $jsonPath -Encoding UTF8
          $rows | Export-Csv -Path $csvPath -NoTypeInformation -Encoding UTF8

          # SARIF (no runAutomationDetails)
          $sarifResults = New-Object System.Collections.Generic.List[object]
          foreach ($r in $rows) {
            $sarifLevel = switch ($r.Severity.ToLowerInvariant()) {
              'error'   { 'error' }
              'warning' { 'warning' }
              default   { 'note' }
            }

            $sarifResults.Add(@{
              ruleId  = $r.RuleName
              level   = $sarifLevel
              message = @{ text = $r.Message }
              locations = @(
                @{
                  physicalLocation = @{
                    artifactLocation = @{ uri = $r.File }
                    region = @{
                      startLine   = $r.Line
                      startColumn = $r.Column
                    }
                  }
                }
              )
            })
          }

          $sarif = @{
            '$schema' = 'http://json.schemastore.org/sarif-2.1.0'
            version   = '2.1.0'
            runs      = @(
              @{
                tool    = @{ driver = @{ name = 'PSScriptAnalyzer'; version = $psaVersion } }
                results = $sarifResults
              }
            )
          }
          $sarif | ConvertTo-Json -Depth 12 | Set-Content -Path $sarifPath -Encoding UTF8

          # Markdown report
          $total  = $rows.Count
          $bySev  = $rows | Group-Object Severity | Sort-Object Name
          $byRule = $rows | Group-Object RuleName | Sort-Object Count -Descending

          $topN     = [int]"${{ env.SUMMARY_TOP }}"
          $topRules = [int]"${{ env.TOP_RULES }}"

          $md = New-Object System.Collections.Generic.List[string]
          $md.Add("# PowerShell Static Analysis Report")
          $md.Add("")
          $md.Add("- **Repo:** $repo")
          $md.Add("- **Commit:** $sha")
          $md.Add("- **Timestamp (UTC):** $ts")
          $md.Add("- **Run:** $runId")
          $md.Add("- **Analyzer:** PSScriptAnalyzer $psaVersion")
          $md.Add("")

          $md.Add("## Summary")
          $md.Add("- **Total findings:** $total")
          foreach ($g in $bySev) { $md.Add("- **$($g.Name):** $($g.Count)") }
          $md.Add("")

          $md.Add("## Top Rules (by count)")
          $md.Add("")
          $md.Add("| Rule | Count |")
          $md.Add("|---|---:|")
          foreach ($r in ($byRule | Select-Object -First $topRules)) {
            $md.Add("| `$($r.Name)` | $($r.Count) |")
          }
          $md.Add("")

          $md.Add("## First $topN Findings")
          $md.Add("")
          $md.Add("| Severity | Rule | File | Line | Message |")
          $md.Add("|---|---|---|---:|---|")

          foreach ($i in ($rows | Select-Object -First $topN)) {
            $fileLink = "https://github.com/$repo/blob/$sha/$($i.File)#L$($i.Line)"
            $msg = ($i.Message -replace '\|','/')
            $md.Add("| $($i.Severity) | `$($i.RuleName)` | [$($i.File)]($fileLink) | $($i.Line) | $msg |")
          }

          [string]::Join([Environment]::NewLine, $md) | Set-Content -Path $mdPath -Encoding UTF8

          # Job Summary
          $summary = New-Object System.Collections.Generic.List[string]
          $summary.Add("### üß™ PowerShell Lint Summary")
          $summary.Add("- üïí **UTC:** $ts")
          $summary.Add("- üîó **Repo:** $repo")
          $summary.Add("- üß∑ **Commit:** $sha")
          $summary.Add("- üßæ **Total findings:** $total")
          foreach ($g in $bySev) { $summary.Add("  - **$($g.Name):** $($g.Count)") }
          $summary.Add("")
          $summary.Add("Artifacts are in `${{ env.OUT_DIR }}`: JSON / CSV / MD / SARIF")

          [string]::Join([Environment]::NewLine, $summary) |
            Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8

          # Gate on configured severities
          $failSev = @("${{ env.FAIL_ON_SEVERITIES }}".Split(" ", [System.StringSplitOptions]::RemoveEmptyEntries))
          if ($failSev.Count -gt 0) {
            $failHits = $rows | Where-Object { $_.Severity -in $failSev }
            if ($failHits.Count -gt 0) {
              throw "Lint gate failed: found $($failHits.Count) finding(s) with severity: $($failSev -join ', ')"
            }
          }

      - name: üì¶ Upload Report Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: powershell-lint-reports
          path: ${{ github.workspace }}\${{ env.OUT_DIR }}
          retention-days: 30

      - name: üõ∞Ô∏è Upload SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ github.workspace }}\${{ env.OUT_DIR }}\${{ env.OUT_SARIF }}
          wait-for-processing: true
