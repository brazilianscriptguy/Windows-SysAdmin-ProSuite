name: VBScript Syntax Validation (Wine + CSCRIPT + SARIF + Summary) [Report-Only]

on:
  push:
    branches: [main, develop]
    paths:
      - "**/*.vbs"
      - "**/*.hta"
      - ".github/workflows/vbscript-syntax-validation.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "**/*.vbs"
      - "**/*.hta"
      - ".github/workflows/vbscript-syntax-validation.yml"
  workflow_dispatch:

concurrency:
  group: vbscript-syntax-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  vbscript-syntax-check:
    name: "üîç VBScript Syntax Validation (SARIF + Summary)"
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      # "true"  => report-only (never fail CI)
      # "false" => enforce (fail CI when errors exist)
      ALLOW_WARNINGS: "true"

      OUT_DIR: "vbscript-reports"
      OUT_SARIF: "vbscript-results.sarif"
      OUT_MD: "vbscript-summary.md"
      OUT_TXT: "vbscript-raw-output.txt"

      # Optional: stop at first error for speed
      FAIL_FAST: "false"

    steps:
      - name: "üì¶ Checkout (short path to avoid long filename issues)"
        uses: actions/checkout@v4
        with:
          path: repo
          fetch-depth: 0

      - name: "üç∑ Setup Wine + tools"
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y wine64 jq python3
          WINEDEBUG=-all wineboot --init

      - name: "üìÅ Prepare output folder + baseline SARIF/MD/TXT"
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${OUT_DIR}"

          cat > "${OUT_DIR}/${OUT_SARIF}" <<'EOF'
          {
            "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
            "version": "2.1.0",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "VBScript Syntax Check (Wine + cscript.exe)",
                    "informationUri": "https://learn.microsoft.com/en-us/previous-versions//d1wf56tt(v=vs.85)"
                  }
                },
                "results": []
              }
            ]
          }
          EOF

          {
            echo "# VBScript Syntax Validation (Report-Only)"
            echo
            echo "| File | Line | Message |"
            echo "|------|------|---------|"
          } > "${OUT_DIR}/${OUT_MD}"

          : > "${OUT_DIR}/${OUT_TXT}"

      - name: "üîé Locate .vbs and .hta files (tracked only)"
        id: files
        working-directory: ./repo
        shell: bash
        run: |
          set -euo pipefail
          git ls-files -z '*.vbs' '*.hta' > ../vbscript-files.txt || true

          if [[ ! -s ../vbscript-files.txt ]]; then
            echo "count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          count="$(tr -cd '\0' < ../vbscript-files.txt | wc -c | tr -d ' ')"
          echo "count=${count}" >> "$GITHUB_OUTPUT"

      - name: "üß∞ Write scanner script (scan.sh)"
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          cat > scan.sh <<'BASH'
          #!/usr/bin/env bash
          set -euo pipefail

          # Inputs from env
          : "${OUT_DIR:?}"
          : "${OUT_SARIF:?}"
          : "${OUT_MD:?}"
          : "${OUT_TXT:?}"
          : "${FAIL_FAST:=false}"

          outdir="${OUT_DIR}"
          sarif="${outdir}/${OUT_SARIF}"
          md="${outdir}/${OUT_MD}"
          raw="${outdir}/${OUT_TXT}"

          # Append SARIF result using jq (safe)
          sarif_add_result() {
            local rel="$1"
            local line="$2"
            local msg="$3"
            local tmp
            tmp="$(mktemp)"
            jq --arg rel "$rel" --arg msg "$msg" --argjson line "$line" '
              .runs[0].results += [{
                ruleId: "vbscript-syntax",
                level: "error",
                message: { text: $msg },
                locations: [{
                  physicalLocation: {
                    artifactLocation: { uri: $rel },
                    region: { startLine: $line }
                  }
                }]
              }]
            ' "$sarif" > "$tmp" && mv "$tmp" "$sarif"
          }

          detect_line() {
            local errfile="$1"
            local line=""

            line="$(grep -ioE 'line[: ]+[0-9]+' "$errfile" | head -n 1 | grep -oE '[0-9]+' || true)"
            if [[ -n "${line:-}" ]]; then echo "$line"; return 0; fi

            line="$(grep -oE '\([0-9]+,[[:space:]]*[0-9]+\)' "$errfile" | head -n 1 | tr -d '()' | cut -d, -f1 | tr -d ' ' || true)"
            if [[ -n "${line:-}" ]]; then echo "$line"; return 0; fi

            echo "1"
          }

          detect_message() {
            local errfile="$1"
            local msg=""
            msg="$(grep -m 1 -iE 'error|erro|compilation|expected|unterminated|invalid|syntax' "$errfile" || true)"
            if [[ -z "${msg// }" ]]; then
              msg="$(head -n 1 "$errfile" 2>/dev/null || true)"
            fi
            if [[ -z "${msg// }" ]]; then
              msg="VBScript syntax error"
            fi
            msg="$(printf '%s' "$msg" | tr -d '\r')"
            printf '%s' "$msg"
          }

          extract_vbscript_from_hta() {
            local file="$1"
            local tmp="$2"

            if ! grep -iq '<script[^>]*language=["'"'"'"]vbscript["'"'"'"]' "$file"; then
              return 1
            fi

            python3 -c "import re,sys; t=open(sys.argv[1],'r',encoding='utf-8',errors='ignore').read(); \
m=re.search(r'<script[^>]*language\\s*=\\s*[\\\"\\x27]vbscript[\\\"\\x27][^>]*>(.*?)</script>', t, flags=re.I|re.S); \
(1/0) if not m else open(sys.argv[2],'w',encoding='utf-8',errors='ignore').write(m.group(1).strip()+'\\n')" \
              "$file" "$tmp" >/dev/null 2>&1
          }

          errors=0

          # repo/ is used as working-directory for the scan step
          while IFS= read -r -d '' file; do
            [[ -z "${file:-}" ]] && continue
            rel="${file#./}"

            echo "==> Checking: ${rel}" >> "$raw"

            if [[ "$file" == *.hta ]]; then
              if grep -iqE '^\s*<(html|!doctype)' "$file" && ! grep -iq '<script[^>]*language=["'"'"'"]vbscript["'"'"'"]' "$file"; then
                echo "::notice file=${rel}::Skipped HTA (HTML content, no VBScript block)"
                echo "SKIP (HTA no VBScript): ${rel}" >> "$raw"
                continue
              fi

              offset="0"
              start_line="$(grep -in '<script[^>]*language=["'"'"'"]vbscript["'"'"'"]' "$file" | head -n 1 | cut -d: -f1 || true)"
              if [[ -n "${start_line:-}" ]]; then offset="$start_line"; fi

              tmp="$(mktemp --suffix=.vbs)"
              if ! extract_vbscript_from_hta "$file" "$tmp"; then
                echo "::notice file=${rel}::Skipped HTA (no VBScript block)"
                echo "SKIP (HTA no VBScript): ${rel}" >> "$raw"
                rm -f "$tmp"
                continue
              fi

              tmp_err="$(mktemp)"
              set +e
              WINEDEBUG=-all wine cscript.exe //nologo //B "$tmp" 2> "$tmp_err" >> "$raw"
              rc="$?"
              set -e

              if [[ "$rc" != "0" ]]; then
                errors=$((errors + 1))
                line="$(detect_line "$tmp_err")"
                msg="$(detect_message "$tmp_err")"

                if [[ "${offset}" =~ ^[0-9]+$ ]] && [[ "${line}" =~ ^[0-9]+$ ]]; then
                  line=$(( line + offset ))
                fi

                echo "::error file=${rel},line=${line}::${msg}"
                echo "| \`${rel}\` | ${line} | ${msg} |" >> "$md"
                sarif_add_result "$rel" "$line" "$msg"

                if [[ "${FAIL_FAST}" == "true" ]]; then
                  rm -f "$tmp" "$tmp_err"
                  break
                fi
              fi

              rm -f "$tmp" "$tmp_err"

            else
              tmp_err="$(mktemp)"
              set +e
              WINEDEBUG=-all wine cscript.exe //nologo //B "$file" 2> "$tmp_err" >> "$raw"
              rc="$?"
              set -e

              if [[ "$rc" != "0" ]]; then
                errors=$((errors + 1))
                line="$(detect_line "$tmp_err")"
                msg="$(detect_message "$tmp_err")"

                echo "::error file=${rel},line=${line}::${msg}"
                echo "| \`${rel}\` | ${line} | ${msg} |" >> "$md"
                sarif_add_result "$rel" "$line" "$msg"

                if [[ "${FAIL_FAST}" == "true" ]]; then
                  rm -f "$tmp_err"
                  break
                fi
              fi

              rm -f "$tmp_err"
            fi

          done < ../vbscript-files.txt

          if [[ "${errors}" -eq 0 ]]; then
            echo "| ‚úÖ No syntax errors found. | - | - |" >> "$md"
          fi

          echo "${errors}" > "${outdir}/errors.count"
          BASH

          chmod +x scan.sh

      - name: "üß™ Run scanner (build SARIF/MD/TXT)"
        id: scan
        if: always()
        working-directory: ./repo
        shell: bash
        run: |
          set -euo pipefail
          ../scan.sh

          errors="0"
          if [[ -f "../${OUT_DIR}/errors.count" ]]; then
            errors="$(cat "../${OUT_DIR}/errors.count" | tr -d '[:space:]')"
          fi
          echo "errors=${errors}" >> "$GITHUB_OUTPUT"

      - name: "üßæ Publish report to Run Summary (View Runs)"
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          errors="${{ steps.scan.outputs.errors || '0' }}"
          files_count="${{ steps.files.outputs.count || '0' }}"

          {
            echo "## üß™ VBScript Syntax Validation (Report-Only)"
            echo
            echo "- **Event:** \`${GITHUB_EVENT_NAME}\`"
            echo "- **Ref:** \`${GITHUB_REF}\`"
            echo "- **Commit:** \`${GITHUB_SHA}\`"
            echo "- **Files matched:** \`${files_count}\`"
            echo "- **Errors:** \`${errors}\`"
            echo "- **ALLOW_WARNINGS:** \`${ALLOW_WARNINGS}\`"
            echo
            echo "### Report"
            echo
            if [[ -f "${OUT_DIR}/${OUT_MD}" ]]; then
              cat "${OUT_DIR}/${OUT_MD}"
            else
              echo "_No markdown report file found:_ \`${OUT_DIR}/${OUT_MD}\`"
            fi
            echo
            echo "### Artifacts"
            echo
            echo "- \`${OUT_DIR}/${OUT_MD}\`"
            echo "- \`${OUT_DIR}/${OUT_SARIF}\`"
            echo "- \`${OUT_DIR}/${OUT_TXT}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: "üì¶ Upload artifacts (reports)"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vbscript-syntax-reports
          path: ${{ env.OUT_DIR }}/**
          if-no-files-found: warn
          retention-days: 30

      - name: "üõ∞Ô∏è Upload SARIF to GitHub Code Scanning"
        if: always() && hashFiles(format('{0}/{1}', env.OUT_DIR, env.OUT_SARIF)) != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ env.OUT_DIR }}/${{ env.OUT_SARIF }}
          category: vbscript/syntax

      - name: "‚úÖ Policy Gate (optional enforcement)"
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${ALLOW_WARNINGS}" == "true" ]]; then
            echo "ALLOW_WARNINGS=true -> report-only mode. Passing."
            exit 0
          fi

          errors="${{ steps.scan.outputs.errors || '0' }}"
          if [[ "${errors}" != "0" ]]; then
            echo "‚ùå VBScript syntax errors detected: ${errors}"
            exit 1
          fi

          echo "‚úÖ No VBScript syntax errors."
