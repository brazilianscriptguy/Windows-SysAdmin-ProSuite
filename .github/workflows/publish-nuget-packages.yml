name: publish-nuget-package

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'ITSM-Templates-WKS.nuspec'
      - 'ITSM-Templates-WKS/**'

jobs:
  build-and-publish:
    runs-on: windows-latest
    env:
      NUGET_SOURCE: https://api.nuget.org/v3/index.json
      PACKAGE_FOLDER: ITSM-Templates-WKS
      NUSPEC_FILE: ITSM-Templates-WKS.nuspec

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup NuGet CLI
        uses: NuGet/setup-nuget@v1
        with:
          nuget-version: latest

      - name: Display Files in Package Directory
        run: |
          Get-ChildItem -Recurse $env:PACKAGE_FOLDER
          Get-Content $env:NUSPEC_FILE

      - name: Restore NuGet packages (if needed)
        run: nuget restore $env:NUSPEC_FILE
        continue-on-error: true

      - name: Pack NuGet Package
        run: |
          nuget pack $env:NUSPEC_FILE -OutputDirectory nupkg-out -Properties Configuration=Release

      - name: Push NuGet Package to nuget.org
        run: |
          $nupkg = Get-ChildItem -Path "nupkg-out" -Filter "*.nupkg" | Select-Object -First 1
          if (-not $nupkg) {
            Write-Error "‚ùå .nupkg not found."
            exit 1
          }
          nuget push $nupkg.FullName `
            -ApiKey "${{ secrets.NUGET_API_KEY }}" `
            -Source "$env:NUGET_SOURCE" `
            -SkipDuplicate
