name: publish-nuget-package

on:
  workflow_dispatch:
  push:
    tags:
      - 'nuget-*'  # Tags like nuget-ITSM.1.0.0

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: windows-latest

    env:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      NUGET_SOURCE: https://api.nuget.org/v3/index.json

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ§° Install NuGet CLI
        uses: nuget/setup-nuget@v1
        with:
          nuget-version: latest

      - name: ğŸ§¼ Clean Previous Artifacts
        run: |
          if (Test-Path -Path "nuget-packages") {
            Remove-Item -Recurse -Force "nuget-packages"
          }
          New-Item -ItemType Directory -Path "nuget-packages" | Out-Null
        shell: pwsh

      - name: ğŸ” Locate and Pack .nuspec Files
        run: |
          $ErrorActionPreference = 'Stop'
          Get-ChildItem -Path . -Recurse -Filter *.nuspec | ForEach-Object {
            Write-Host "ğŸ“¦ Packing: $($_.FullName)"
            & nuget pack $_.FullName -OutputDirectory "nuget-packages" -NoDefaultExcludes
          }
        shell: pwsh

      - name: ğŸ“¤ Push NuGet Packages
        run: |
          $ErrorActionPreference = 'Stop'
          Get-ChildItem -Path "nuget-packages" -Filter *.nupkg | ForEach-Object {
            Write-Host "ğŸš€ Pushing package: $($_.Name)"
            & nuget push $_.FullName `
              -ApiKey "$env:NUGET_API_KEY" `
              -Source "$env:NUGET_SOURCE" `
              -NonInteractive
          }
        shell: pwsh
