name: publish-itsm-nuget

on:
  workflow_dispatch:
  push:
    tags:
      - 'nuget-itsm-*'  # Example: nuget-itsm-1.0.0

permissions:
  contents: read
  packages: write

jobs:
  publish-itsm-templates-wks:
    name: 📦 Publish ITSM-Templates-WKS to NuGet
    runs-on: windows-latest

    env:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      NUGET_SOURCE: https://api.nuget.org/v3/index.json

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 🧰 Setup NuGet CLI
        uses: nuget/setup-nuget@v1
        with:
          nuget-version: latest

      - name: 📦 Pack .nuspec
        run: |
          nuget pack ITSM-Templates-WKS.nuspec -OutputDirectory nuget-packages -NoDefaultExcludes
        shell: pwsh

      - name: 🚀 Push Package to NuGet.org
        run: |
          $pkg = Get-ChildItem -Path nuget-packages -Filter *.nupkg | Select-Object -First 1
          if ($pkg) {
            Write-Host "Pushing $($pkg.Name)"
            nuget push $pkg.FullName -ApiKey "$env:NUGET_API_KEY" -Source "$env:NUGET_SOURCE" -NonInteractive
          } else {
            Write-Error "❌ No NuGet package found to publish."
          }
        shell: pwsh
