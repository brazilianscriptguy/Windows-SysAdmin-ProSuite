name: publish-nuget-package

on:
  workflow_dispatch:
  push:
    tags:
      - "ITSM-Templates-WKS-v*"

permissions:
  contents: read
  packages: write

jobs:
  pack-and-publish:
    runs-on: windows-latest
    env:
      PACKAGE_ID: ITSM-Templates-WKS
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

    steps:
      - name: âœ… Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ§° Ensure nuget.exe is available
        run: |
          curl -L -o nuget.exe https://dist.nuget.org/win-x86-commandline/latest/nuget.exe

      - name: ğŸ“‚ List Package Files
        run: |
          Write-Host "Listing files to be included in the package:"
          Get-ChildItem -Recurse -Path ./ITSM-Templates-WKS

      - name: ğŸ“¦ Pack NuGet Package
        run: |
          $ErrorActionPreference = "Stop"
          if (-Not (Test-Path "./${{ env.PACKAGE_ID }}.nuspec")) {
            Write-Error "âŒ .nuspec file not found at ./${{ env.PACKAGE_ID }}.nuspec"
          }
          ./nuget.exe pack "./${{ env.PACKAGE_ID }}.nuspec" -OutputDirectory .

      - name: ğŸš€ Push NuGet Package to nuget.org
        run: |
          $packagePath = Get-ChildItem *.nupkg | Where-Object { $_.Name -like "${{ env.PACKAGE_ID }}*" }
          if (-Not $packagePath) {
            Write-Error "âŒ NuGet package not found after packing."
          }
          ./nuget.exe push $packagePath -ApiKey "${{ env.NUGET_API_KEY }}" -Source "https://api.nuget.org/v3/index.json" -SkipDuplicate -Verbosity detailed
