name: VBScript Syntax Check

on:
  push:
    branches: [main, develop]
    paths:
      - '**/*.vbs'
      - '**/*.hta'

  pull_request:
    branches: [main, develop]
    paths:
      - '**/*.vbs'
      - '**/*.hta'

  workflow_dispatch:

jobs:
  vbscript-lint:
    name: VBScript Syntax Validation
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout Repository (short path to avoid path errors)
        uses: actions/checkout@v4
        with:
          path: repo

      - name: 🔍 Locate .vbs and .hta Files
        working-directory: ./repo
        run: |
          find . -type f \( -iname "*.vbs" -o -iname "*.hta" \) > vbscript-files.txt
          cat vbscript-files.txt || echo "No .vbs or .hta files found."

      - name: ✅ Heuristic Check and SARIF Generation
        working-directory: ./repo
        run: |
          mkdir -p sarif-output
          echo '{"version":"2.1.0","runs":[{"tool":{"driver":{"name":"VBScript Syntax Check","informationUri":"https://learn.microsoft.com/en-us/previous-versions//d1wf56tt(v=vs.85)","rules":[]}},"results":[' > sarif-output/vbscript-results.sarif

          first=true
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "🔍 Checking: $file"
              if file "$file" | grep -qi "text"; then
                echo "✔️ Valid text file: $file"
              else
                echo "::warning file=$file::Not a valid text-based VBScript or HTA file."
                if [ "$first" = false ]; then echo "," >> sarif-output/vbscript-results.sarif; fi
                echo "{
                  \"ruleId\": \"non-text-vbs\",
                  \"level\": \"warning\",
                  \"message\": {\"text\": \"File is not a valid text-based VBScript or HTA file.\"},
                  \"locations\": [{
                    \"physicalLocation\": {
                      \"artifactLocation\": {\"uri\": \"${file#./}\"},
                      \"region\": {\"startLine\": 1}
                    }
                  }]
                }" >> sarif-output/vbscript-results.sarif
                first=false
              fi
            fi
          done < vbscript-files.txt

          echo "]}]}" >> sarif-output/vbscript-results.sarif

      - name: 📤 Upload SARIF Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vbscript-sarif-results
          path: repo/sarif-output/vbscript-results.sarif

      - name: 📡 Publish SARIF to GitHub Code Scanning Alerts
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: repo/sarif-output/vbscript-results.sarif
