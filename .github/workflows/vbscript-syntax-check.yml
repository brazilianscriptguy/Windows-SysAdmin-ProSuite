name: VBScript Syntax Check

on:
  push:
    branches: [main, develop]
    paths:
      - '**/*.vbs'
      - '**/*.hta'
  pull_request:
    branches: [main, develop]
    paths:
      - '**/*.vbs'
      - '**/*.hta'
  workflow_dispatch:

jobs:
  vbscript-lint:
    name: 🧪 VBScript Syntax Validation (Wine + Ubuntu)
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout Repository (short path to prevent long file issues)
        uses: actions/checkout@v4
        with:
          path: src

      - name: 🍷 Install Wine and VBScript Runtime
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y wine64 wine32 cabextract unzip
          mkdir -p ~/.wine/drive_c/windows/system32
          echo "[✔️] Wine installed successfully"

      - name: 📂 Find .vbs and .hta Files
        working-directory: ./src
        run: |
          find . -type f \( -iname "*.vbs" -o -iname "*.hta" \) > vbscript-files.txt
          cat vbscript-files.txt || echo "No VBS or HTA files found"

      - name: 🧠 Analyze and Validate VBScript Files
        working-directory: ./src
        run: |
          mkdir -p sarif
          echo '{"version":"2.1.0","runs":[{"tool":{"driver":{"name":"VBScript Syntax Check","informationUri":"https://learn.microsoft.com/en-us/previous-versions//d1wf56tt(v=vs.85)","rules":[]}},"results":[' > sarif/results.sarif

          while IFS= read -r file; do
            echo "Checking: $file"

            if [[ "$file" == *.hta ]]; then
              if ! grep -qi '<script[^>]*language="VBScript"' "$file"; then
                echo "Skipping non-VBScript HTA: $file"
                continue
              fi
            fi

            if file "$file" | grep -qi text; then
              wine cscript.exe //nologo "$file" 2> stderr.txt
              exitCode=$?

              if [ $exitCode -ne 0 ]; then
                msg=$(<stderr.txt)
                msg=${msg//\"/\\\"}
                echo "{\"level\": \"error\", \"message\": {\"text\": \"$msg\"}, \"locations\": [{\"physicalLocation\": {\"artifactLocation\": {\"uri\": \"$file\"}}}]}," >> sarif/results.sarif
              fi
            fi
          done < vbscript-files.txt

          sed -i '$ s/},$/}]/' sarif/results.sarif
          echo '}]}]' >> sarif/results.sarif

      - name: 📤 Upload SARIF Results
        uses: actions/upload-artifact@v4
        with:
          name: vbscript-syntax-results
          path: src/sarif/results.sarif
          if-no-files-found: warn

      - name: 🚨 Upload to GitHub Code Scanning (optional)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: src/sarif/results.sarif
